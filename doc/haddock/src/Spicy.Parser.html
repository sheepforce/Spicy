<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Spicy.Parser
Description : Parsers for chemical data formats and computational chemistry output files.
Copyright   : Phillip Seeber, 2019
License     : GPL-3
Maintainer  : phillip.seeber@uni-jena.de
Stability   : experimental
Portability : POSIX, Windows

-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Spicy.Parser</span><span>
</span><a name="line-13"></a><span class="hs-special">(</span><span> </span><span class="hs-comment">-- * Chemical Data Formats</span><span>
</span><a name="line-14"></a><span>  </span><a href="Spicy.Parser.html#parseXYZ"><span class="hs-identifier hs-var">parseXYZ</span></a><span>
</span><a name="line-15"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parseTXYZ"><span class="hs-identifier hs-var">parseTXYZ</span></a><span>
</span><a name="line-16"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parseMOL2"><span class="hs-identifier hs-var">parseMOL2</span></a><span>
</span><a name="line-17"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parsePDB"><span class="hs-identifier hs-var">parsePDB</span></a><span>
</span><a name="line-18"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parseSpicy"><span class="hs-identifier hs-var">parseSpicy</span></a><span>
</span><a name="line-19"></a><span class="hs-comment">-- * Generic formats</span><span>
</span><a name="line-20"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parseHMatrix"><span class="hs-identifier hs-var">parseHMatrix</span></a><span>
</span><a name="line-21"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Accelerate</span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Attoparsec.Text.Lazy</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Char</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IntMap</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IntSet</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntSet</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Sequence</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Sequence</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TS</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text.Lazy</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TL</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Tuple</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Lens.Micro.Platform</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>                   </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cycle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">head</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                            </span><span class="hs-identifier hs-var">init</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">last</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">maximum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">minimum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tail</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                            </span><span class="hs-identifier hs-var">take</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">!!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Molecule.Util.html"><span class="hs-identifier">Spicy.Molecule.Util</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Types.html"><span class="hs-identifier">Spicy.Types</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Read</span><span>
</span><a name="line-44"></a><span class="hs-comment">--import Data.Monoid</span><span>
</span><a name="line-45"></a><span class="hs-comment">--import Data.Sequence (Seq)</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">{-|
Make a parser optional and wrap it in a 'Maybe'.
-}</span><span>
</span><a name="line-51"></a><span class="hs-identifier">maybeOption</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="#local-6989586621679240027"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679240027"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><a name="maybeOption"><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier">maybeOption</span></a></a><span> </span><a name="local-6989586621679240028"><a href="#local-6989586621679240028"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">option</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679240028"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">{-|
Parser for skiping non line breaking space.
-}</span><span>
</span><a name="line-57"></a><span class="hs-identifier">skipSpace'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><a name="skipSpace%27"><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier">skipSpace'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-59"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-char">' '</span><span class="hs-special">,</span><span> </span><span class="hs-char">'\t'</span><span class="hs-special">,</span><span> </span><span class="hs-char">'\f'</span><span class="hs-special">,</span><span> </span><span class="hs-char">'\v'</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">----------------------------------------------------------------------------------------------------</span><span>
</span><a name="line-63"></a><span class="hs-comment">{-|
Parse a .xyz file (has no connectivity, atom types or partioal charges).
-}</span><span>
</span><a name="line-66"></a><span class="hs-identifier">parseXYZ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-67"></a><a name="parseXYZ"><a href="Spicy.Parser.html#parseXYZ"><span class="hs-identifier">parseXYZ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-68"></a><span>  </span><a name="local-6989586621679240516"><a href="#local-6989586621679240516"><span class="hs-identifier">nAtoms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-keyword">label</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-70"></a><span>  </span><a name="local-6989586621679240518"><a href="#local-6989586621679240518"><span class="hs-identifier">atoms</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="#local-6989586621679240516"><span class="hs-identifier hs-var">nAtoms</span></a><span> </span><a href="#local-6989586621679240225"><span class="hs-identifier hs-var">xyzLineParser</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-72"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TS.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679240518"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-76"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-77"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-78"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-identifier">xyzLineParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span>
</span><a name="line-82"></a><span>    </span><a name="local-6989586621679240225"><a href="#local-6989586621679240225"><span class="hs-identifier">xyzLineParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-83"></a><span>      </span><a name="local-6989586621679240512"><a href="#local-6989586621679240512"><span class="hs-identifier">cElement</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span>
</span><a name="line-84"></a><span>      </span><a name="local-6989586621679240513"><a href="#local-6989586621679240513"><span class="hs-identifier">x</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-85"></a><span>      </span><a name="local-6989586621679240514"><a href="#local-6989586621679240514"><span class="hs-identifier">y</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-86"></a><span>      </span><a name="local-6989586621679240515"><a href="#local-6989586621679240515"><span class="hs-identifier">z</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-87"></a><span>      </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-var">Atom</span></a><span>
</span><a name="line-89"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_atom_Element</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Spicy.Types.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679240512"><span class="hs-identifier hs-var">cElement</span></a><span>
</span><a name="line-90"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Label</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-91"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_IsPseudo</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_FFType</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_PCharge</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679240513"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240514"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240515"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">{-|
Parse a Tinker XYZ formatted file. It has coordinates and might have connectivity and atom types.
This format and therefore parser are not using any layers (recursions of 'Molecule').
-}</span><span>
</span><a name="line-101"></a><span class="hs-identifier">parseTXYZ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-102"></a><a name="parseTXYZ"><a href="Spicy.Parser.html#parseTXYZ"><span class="hs-identifier">parseTXYZ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-103"></a><span>  </span><a name="local-6989586621679240706"><a href="#local-6989586621679240706"><span class="hs-identifier">_nAtoms</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-keyword">label</span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-105"></a><span>  </span><a name="local-6989586621679240708"><a href="#local-6989586621679240708"><span class="hs-identifier">conAndAtoms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><a href="#local-6989586621679240695"><span class="hs-identifier hs-var">txyzLineParser</span></a><span>
</span><a name="line-106"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TS.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679240709"><a href="#local-6989586621679240709"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679240709"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_1</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240709"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_2</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679240708"><span class="hs-identifier hs-var">conAndAtoms</span></a><span>
</span><a name="line-109"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679240708"><span class="hs-identifier hs-var">conAndAtoms</span></a><span>
</span><a name="line-110"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-116"></a><span>    </span><span class="hs-comment">-- Parsing a single line of atoms. Tinker's format keeps bonds associated with atoms. So a tuple</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-comment">-- suitable to construct the 'IntMap' is returned additional to the pure atoms.</span><span>
</span><a name="line-118"></a><span>    </span><span class="hs-identifier">txyzLineParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621679240695"><a href="#local-6989586621679240695"><span class="hs-identifier">txyzLineParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-120"></a><span>      </span><a name="local-6989586621679240698"><a href="#local-6989586621679240698"><span class="hs-identifier">index</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679240697"><a href="#local-6989586621679240697"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679240697"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>      </span><a name="local-6989586621679240699"><a href="#local-6989586621679240699"><span class="hs-identifier">cElement</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span>
</span><a name="line-122"></a><span>      </span><a name="local-6989586621679240700"><a href="#local-6989586621679240700"><span class="hs-identifier">x</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-123"></a><span>      </span><a name="local-6989586621679240701"><a href="#local-6989586621679240701"><span class="hs-identifier">y</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-124"></a><span>      </span><a name="local-6989586621679240702"><a href="#local-6989586621679240702"><span class="hs-identifier">z</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-125"></a><span>      </span><a name="local-6989586621679240703"><a href="#local-6989586621679240703"><span class="hs-identifier">mFFType</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-126"></a><span>      </span><a name="local-6989586621679240704"><a href="#local-6989586621679240704"><span class="hs-identifier">connectivityRaw</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many'</span><span> </span><a href="#local-6989586621679240696"><span class="hs-identifier hs-var">columnDecimal</span></a><span>
</span><a name="line-127"></a><span>      </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-128"></a><span>      </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679240698"><span class="hs-identifier hs-var">index</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IS.fromList</span><span> </span><a href="#local-6989586621679240704"><span class="hs-identifier hs-var">connectivityRaw</span></a><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-var">Atom</span></a><span>
</span><a name="line-131"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_atom_Element</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Spicy.Types.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679240699"><span class="hs-identifier hs-var">cElement</span></a><span>
</span><a name="line-132"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Label</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-133"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_IsPseudo</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-134"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_FFType</span><span>       </span><span class="hs-glyph">=</span><span>
</span><a name="line-135"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679240703"><span class="hs-identifier hs-var">mFFType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-136"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-137"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679240705"><a href="#local-6989586621679240705"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679240705"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_PCharge</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-139"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679240700"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240701"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240702"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span>
</span><a name="line-140"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-141"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>    </span><span class="hs-comment">-- Parse multiple non-line-breaking whitespace separated decimals.</span><span>
</span><a name="line-143"></a><span>    </span><span class="hs-identifier">columnDecimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-144"></a><span>    </span><a name="local-6989586621679240696"><a href="#local-6989586621679240696"><span class="hs-identifier">columnDecimal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">{-|
Parse the &quot;interesting&quot; fields of a MOL2 file. This contains partial charges as well as
connectivity. There is no special understanding for the atom types, that are available in MOL2
files. They will simply be treated as the force field string. See
&lt;http://chemyang.ccnu.edu.cn/ccb/server/AIMMS/mol2.pdf&gt;.
-}</span><span>
</span><a name="line-152"></a><span class="hs-identifier">parseMOL2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-153"></a><a name="parseMOL2"><a href="Spicy.Parser.html#parseMOL2"><span class="hs-identifier">parseMOL2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-154"></a><span>  </span><span class="hs-special">(</span><span class="hs-keyword">label</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679241064"><a href="#local-6989586621679241064"><span class="hs-identifier">nAtoms</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679241065"><a href="#local-6989586621679241065"><span class="hs-identifier">nBonds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679240710"><span class="hs-identifier hs-var">moleculeParser</span></a><span>
</span><a name="line-155"></a><span>  </span><a name="local-6989586621679241066"><a href="#local-6989586621679241066"><span class="hs-identifier">atomsLabeled</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679240711"><span class="hs-identifier hs-var">atomParser</span></a><span> </span><a href="#local-6989586621679241064"><span class="hs-identifier hs-var">nAtoms</span></a><span>
</span><a name="line-156"></a><span>  </span><a name="local-6989586621679241067"><a href="#local-6989586621679241067"><span class="hs-identifier">bonds</span></a></a><span>                   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679240712"><span class="hs-identifier hs-var">bondParser</span></a><span> </span><a href="#local-6989586621679241065"><span class="hs-identifier hs-var">nBonds</span></a><span>
</span><a name="line-157"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Construct the top layer of the molecule.</span><span>
</span><a name="line-158"></a><span>      </span><a name="local-6989586621679241068"><a href="#local-6989586621679241068"><span class="hs-identifier">atoms</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679241072"><a href="#local-6989586621679241072"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679241073"><a href="#local-6989586621679241073"><span class="hs-identifier">atom</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679241072"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679241073"><span class="hs-identifier hs-var">atom</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679241066"><span class="hs-identifier hs-var">atomsLabeled</span></a><span>
</span><a name="line-159"></a><span>      </span><span class="hs-comment">-- Sort the labeled atoms based on their substructure IDs.</span><span>
</span><a name="line-160"></a><span>      </span><span class="hs-identifier">subMolGroups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TL.Text</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>      </span><a name="local-6989586621679241069"><a href="#local-6989586621679241069"><span class="hs-identifier">subMolGroups</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-162"></a><span>          </span><a href="Spicy.Molecule.Util.html#groupBy"><span class="hs-identifier hs-var">groupBy</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679241074"><a href="#local-6989586621679241074"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679241075"><a href="#local-6989586621679241075"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679241074"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_2</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_1</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679241075"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_2</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_1</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.unstableSortOn</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679241076"><a href="#local-6989586621679241076"><span class="hs-identifier">subID</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679241076"><span class="hs-identifier hs-var">subID</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span>
</span><a name="line-165"></a><span>        </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679241066"><span class="hs-identifier hs-var">atomsLabeled</span></a><span>
</span><a name="line-166"></a><span>      </span><span class="hs-comment">-- From the groups of same substructure ID fragments, build molecules.</span><span>
</span><a name="line-167"></a><span>      </span><a name="local-6989586621679241070"><a href="#local-6989586621679241070"><span class="hs-identifier">subMols</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679241077"><a href="#local-6989586621679241077"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679241071"><span class="hs-identifier hs-var">makeSubMolFromGroup</span></a><span> </span><a href="#local-6989586621679241077"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679241067"><span class="hs-identifier hs-var">bonds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679241069"><span class="hs-identifier hs-var">subMolGroups</span></a><span>
</span><a name="line-168"></a><span>      </span><span class="hs-comment">-- Assume we get properly sorted groups (all subIDs are them same): Build a new molecule from</span><span>
</span><a name="line-169"></a><span>      </span><span class="hs-comment">-- this group.</span><span>
</span><a name="line-170"></a><span>      </span><span class="hs-identifier">makeSubMolFromGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TL.Text</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-171"></a><span>      </span><a name="local-6989586621679241071"><a href="#local-6989586621679241071"><span class="hs-identifier">makeSubMolFromGroup</span></a></a><span> </span><a name="local-6989586621679241078"><a href="#local-6989586621679241078"><span class="hs-identifier">group</span></a></a><span> </span><a name="local-6989586621679241079"><a href="#local-6989586621679241079"><span class="hs-identifier">bonds'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-172"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679241080"><a href="#local-6989586621679241080"><span class="hs-identifier">atoms'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679241084"><a href="#local-6989586621679241084"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679241085"><a href="#local-6989586621679241085"><span class="hs-identifier">atom</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679241084"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679241085"><span class="hs-identifier hs-var">atom</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679241078"><span class="hs-identifier hs-var">group</span></a><span>
</span><a name="line-173"></a><span>            </span><a name="local-6989586621679241081"><a href="#local-6989586621679241081"><span class="hs-identifier">label'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">S.!?</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_2</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_2</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679241078"><span class="hs-identifier hs-var">group</span></a><span>
</span><a name="line-174"></a><span>            </span><a name="local-6989586621679241082"><a href="#local-6989586621679241082"><span class="hs-identifier">atomInds</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><a href="#local-6989586621679241080"><span class="hs-identifier hs-var">atoms'</span></a><span>
</span><a name="line-175"></a><span>            </span><span class="hs-comment">-- Remove all bonds from the IntMap, that have origin on atoms not in this set and all</span><span>
</span><a name="line-176"></a><span>            </span><span class="hs-comment">-- target atoms that are not in the set.</span><span>
</span><a name="line-177"></a><span>            </span><span class="hs-identifier">bondsCleaned</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span>
</span><a name="line-178"></a><span>            </span><a name="local-6989586621679241083"><a href="#local-6989586621679241083"><span class="hs-identifier">bondsCleaned</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-179"></a><span>                </span><span class="hs-identifier hs-var">IM.map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS.filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">IS.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679241082"><span class="hs-identifier hs-var">atomInds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>              </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679241079"><span class="hs-identifier hs-var">bonds'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">IM.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679241082"><span class="hs-identifier hs-var">atomInds</span></a><span>
</span><a name="line-181"></a><span>        </span><span class="hs-keyword">in</span><span>  </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-182"></a><span>              </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679241081"><span class="hs-identifier hs-var">label'</span></a><span>
</span><a name="line-183"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679241080"><span class="hs-identifier hs-var">atoms'</span></a><span>
</span><a name="line-184"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679241083"><span class="hs-identifier hs-var">bondsCleaned</span></a><span>
</span><a name="line-185"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-186"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-187"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-188"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-189"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-191"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679241068"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-193"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679241067"><span class="hs-identifier hs-var">bonds</span></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679241070"><span class="hs-identifier hs-var">subMols</span></a><span>
</span><a name="line-195"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-199"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-comment">-- Parse the @&lt;TRIPOS&gt;MOLECULE block of MOL2.</span><span>
</span><a name="line-201"></a><span>    </span><span class="hs-identifier">moleculeParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TL.Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621679240710"><a href="#local-6989586621679240710"><span class="hs-identifier">moleculeParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-203"></a><span>      </span><a name="local-6989586621679240713"><a href="#local-6989586621679240713"><span class="hs-identifier">_header</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;@&lt;TRIPOS&gt;MOLECULE&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-204"></a><span>      </span><span class="hs-comment">-- Line 1 -&gt; &quot;mol_name&quot;</span><span>
</span><a name="line-205"></a><span>      </span><span class="hs-keyword">label</span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-206"></a><span>      </span><span class="hs-comment">--traceShowM label</span><span>
</span><a name="line-207"></a><span>      </span><span class="hs-comment">-- Line 2 -&gt; &quot;num_atoms [num_bonds [num_subst [num_feat [num_sets]]]]&quot;</span><span>
</span><a name="line-208"></a><span>      </span><a name="local-6989586621679240715"><a href="#local-6989586621679240715"><span class="hs-identifier">nAtoms</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-209"></a><span>      </span><a name="local-6989586621679240716"><a href="#local-6989586621679240716"><span class="hs-identifier">nBonds</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-210"></a><span>      </span><a name="local-6989586621679240717"><a href="#local-6989586621679240717"><span class="hs-identifier">_nSubMols</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>      </span><a name="local-6989586621679240718"><a href="#local-6989586621679240718"><span class="hs-identifier">_nFeatures</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>      </span><a name="local-6989586621679240719"><a href="#local-6989586621679240719"><span class="hs-identifier">_nSets</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-213"></a><span>      </span><span class="hs-comment">-- Line 3 -&gt; &quot;mol_type&quot;</span><span>
</span><a name="line-214"></a><span>      </span><a name="local-6989586621679240720"><a href="#local-6989586621679240720"><span class="hs-identifier">_molType</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-215"></a><span>            </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span>
</span><a name="line-216"></a><span>        </span><span class="hs-operator hs-var">*&gt;</span><span>  </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;SMALL&quot;</span><span>
</span><a name="line-217"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;BIOPOLYMER&quot;</span><span>
</span><a name="line-218"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;PROTEIN&quot;</span><span>
</span><a name="line-219"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;NUCLEIC_ACID&quot;</span><span>
</span><a name="line-220"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;SACCHARIDE&quot;</span><span>
</span><a name="line-221"></a><span>        </span><span class="hs-operator hs-var">&lt;*</span><span>  </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-222"></a><span>      </span><span class="hs-comment">-- Line 4 -&gt; &quot;charge_type&quot;</span><span>
</span><a name="line-223"></a><span>      </span><a name="local-6989586621679240721"><a href="#local-6989586621679240721"><span class="hs-identifier">_chargeType</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-224"></a><span>            </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-operator hs-var">*&gt;</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;NO_CHARGES&quot;</span><span>
</span><a name="line-226"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;DEL_RE&quot;</span><span>
</span><a name="line-227"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;GASTEIGER&quot;</span><span>
</span><a name="line-228"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;GAST_HUCK&quot;</span><span>
</span><a name="line-229"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;HUCKEL&quot;</span><span>
</span><a name="line-230"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;PULLMAN&quot;</span><span>
</span><a name="line-231"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;GAUSS80_CHARGES&quot;</span><span>
</span><a name="line-232"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;AMPAC_CHARGES&quot;</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;MULLIKEN_CHARGES&quot;</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;DICT_CHARGES&quot;</span><span>
</span><a name="line-235"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;MMFF94_CHARGES&quot;</span><span>
</span><a name="line-236"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;USER_CHARGES&quot;</span><span>
</span><a name="line-237"></a><span>        </span><span class="hs-special">)</span><span class="hs-operator hs-var">&lt;*</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span>
</span><a name="line-238"></a><span>        </span><span class="hs-operator hs-var">&lt;*</span><span>  </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-239"></a><span>      </span><span class="hs-comment">-- Line 5 -&gt; &quot;[status_bits&quot;</span><span>
</span><a name="line-240"></a><span>      </span><a name="local-6989586621679240722"><a href="#local-6989586621679240722"><span class="hs-identifier">_statusBit</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-241"></a><span>      </span><span class="hs-comment">-- Line 6 -&gt; &quot;[mol_comment]]&quot;</span><span>
</span><a name="line-242"></a><span>      </span><a name="local-6989586621679240723"><a href="#local-6989586621679240723"><span class="hs-identifier">_comment</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-243"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TS.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">label</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240715"><span class="hs-identifier hs-var">nAtoms</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240716"><span class="hs-identifier hs-var">nBonds</span></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-comment">-- Parse the @&lt;TRIPOS&gt;ATOM block of MOL2. This will give:</span><span>
</span><a name="line-246"></a><span>    </span><span class="hs-comment">-- (index of the atom, (substructure ID, substructure name), atom).</span><span>
</span><a name="line-247"></a><span>    </span><span class="hs-identifier">atomParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TL.Text</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-248"></a><span>    </span><a name="local-6989586621679240711"><a href="#local-6989586621679240711"><span class="hs-identifier">atomParser</span></a></a><span> </span><a name="local-6989586621679240724"><a href="#local-6989586621679240724"><span class="hs-identifier">nAtoms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-249"></a><span>      </span><a name="local-6989586621679240725"><a href="#local-6989586621679240725"><span class="hs-identifier">_header</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;@&lt;TRIPOS&gt;ATOM&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-250"></a><span>      </span><span class="hs-comment">-- Parse multiple lines of ATOM data.</span><span>
</span><a name="line-251"></a><span>      </span><a name="local-6989586621679240740"><a href="#local-6989586621679240740"><span class="hs-identifier">atoms</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="#local-6989586621679240724"><span class="hs-identifier hs-var">nAtoms</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- atomLineParser</span><span>
</span><a name="line-252"></a><span>        </span><a name="local-6989586621679240727"><a href="#local-6989586621679240727"><span class="hs-identifier">index</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679240726"><a href="#local-6989586621679240726"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679240726"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-comment">-- Most often this will be the element symbol.</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-keyword">label</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isHorizontalSpace</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>        </span><span class="hs-comment">-- x, y and z coordinates</span><span>
</span><a name="line-256"></a><span>        </span><a name="local-6989586621679240729"><a href="#local-6989586621679240729"><span class="hs-identifier">x</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-257"></a><span>        </span><a name="local-6989586621679240730"><a href="#local-6989586621679240730"><span class="hs-identifier">y</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-258"></a><span>        </span><a name="local-6989586621679240731"><a href="#local-6989586621679240731"><span class="hs-identifier">z</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-259"></a><span>        </span><span class="hs-comment">-- Parse the chemical element, which is actually the first part of the SYBYL atom type.</span><span>
</span><a name="line-260"></a><span>        </span><a name="local-6989586621679240732"><a href="#local-6989586621679240732"><span class="hs-identifier">cElem</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-comment">-- A dot often separates the element from the type of this element.</span><span>
</span><a name="line-262"></a><span>        </span><a name="local-6989586621679240733"><a href="#local-6989586621679240733"><span class="hs-identifier">ffdot</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'.'</span><span>
</span><a name="line-263"></a><span>        </span><span class="hs-comment">-- And after the dot the rest of the SYBYL atom type might come.</span><span>
</span><a name="line-264"></a><span>        </span><a name="local-6989586621679240734"><a href="#local-6989586621679240734"><span class="hs-identifier">ffType</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isHorizontalSpace</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>        </span><span class="hs-comment">-- The substructure ID. This is the identifier to identify sub molecules.</span><span>
</span><a name="line-266"></a><span>        </span><a name="local-6989586621679240735"><a href="#local-6989586621679240735"><span class="hs-identifier">subID</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-comment">-- The substructure Name. This should be used as label for the sub molecule.</span><span>
</span><a name="line-268"></a><span>        </span><a name="local-6989586621679240736"><a href="#local-6989586621679240736"><span class="hs-identifier">subName</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isHorizontalSpace</span><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>        </span><span class="hs-comment">-- The partial charge</span><span>
</span><a name="line-270"></a><span>        </span><a name="local-6989586621679240737"><a href="#local-6989586621679240737"><span class="hs-identifier">pCharge</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-271"></a><span>        </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-272"></a><span>          </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679240727"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-273"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679240735"><span class="hs-identifier hs-var">subID</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TS.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679240736"><span class="hs-identifier hs-var">subName</span></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-var">Atom</span></a><span>
</span><a name="line-275"></a><span>              </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_atom_Element</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Spicy.Types.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679240732"><span class="hs-identifier hs-var">cElem</span></a><span>
</span><a name="line-276"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Label</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TS.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-277"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_IsPseudo</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-278"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_FFType</span><span>      </span><span class="hs-glyph">=</span><span>
</span><a name="line-279"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TL.pack</span><span> </span><a href="#local-6989586621679240732"><span class="hs-identifier hs-var">cElem</span></a><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TL.append</span><span class="hs-special">`</span><span>
</span><a name="line-281"></a><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679240738"><a href="#local-6989586621679240738"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679240738"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-282"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679240739"><a href="#local-6989586621679240739"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679240739"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-283"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-284"></a><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679240733"><span class="hs-identifier hs-var">ffdot</span></a><span>
</span><a name="line-285"></a><span>                  </span><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TL.append</span><span class="hs-special">`</span><span>
</span><a name="line-287"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TS.unpack</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679240734"><span class="hs-identifier hs-var">ffType</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_PCharge</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679240737"><span class="hs-identifier hs-var">pCharge</span></a><span>
</span><a name="line-289"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679240729"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240730"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240731"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span>
</span><a name="line-290"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-291"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679240740"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-293"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-294"></a><span>    </span><span class="hs-comment">-- Parse the @&lt;TRIPOS&gt;BOND part. Unfortunately, the bonds in the MOL2 format are unidirectiorial</span><span>
</span><a name="line-295"></a><span>    </span><span class="hs-comment">-- and need to be flipped to.</span><span>
</span><a name="line-296"></a><span>    </span><span class="hs-identifier">bondParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>    </span><a name="local-6989586621679240712"><a href="#local-6989586621679240712"><span class="hs-identifier">bondParser</span></a></a><span> </span><a name="local-6989586621679240741"><a href="#local-6989586621679240741"><span class="hs-identifier">nBonds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-298"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- How often to parse bond fields depends on if the number of bonds has been specified.</span><span>
</span><a name="line-299"></a><span>          </span><a name="local-6989586621679240742"><a href="#local-6989586621679240742"><span class="hs-identifier">nParser</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-300"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679240741"><span class="hs-identifier hs-var">nBonds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-301"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">many'</span><span>
</span><a name="line-302"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679240743"><a href="#local-6989586621679240743"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="#local-6989586621679240743"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-303"></a><span>      </span><a name="local-6989586621679240744"><a href="#local-6989586621679240744"><span class="hs-identifier">_header</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;@&lt;TRIPOS&gt;BOND&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-304"></a><span>      </span><a name="local-6989586621679241058"><a href="#local-6989586621679241058"><span class="hs-identifier">uniBonds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679240742"><span class="hs-identifier hs-var">nParser</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-305"></a><span>        </span><span class="hs-comment">-- Bond id, which does not matter.</span><span>
</span><a name="line-306"></a><span>        </span><a name="local-6989586621679240745"><a href="#local-6989586621679240745"><span class="hs-identifier">_id</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>        </span><span class="hs-comment">-- Origin atom index</span><span>
</span><a name="line-308"></a><span>        </span><a name="local-6989586621679240747"><a href="#local-6989586621679240747"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679240746"><a href="#local-6989586621679240746"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679240746"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>        </span><span class="hs-comment">-- Target atom index</span><span>
</span><a name="line-310"></a><span>        </span><a name="local-6989586621679240749"><a href="#local-6989586621679240749"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679240748"><a href="#local-6989586621679240748"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679240748"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>        </span><span class="hs-comment">-- Bond type, which we don't care about.</span><span>
</span><a name="line-312"></a><span>        </span><a name="local-6989586621679241057"><a href="#local-6989586621679241057"><span class="hs-identifier">_type</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isSpace</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679240747"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679240749"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Make the bonds bidirectorial</span><span>
</span><a name="line-315"></a><span>          </span><a name="local-6989586621679241059"><a href="#local-6989586621679241059"><span class="hs-identifier">bondTupleSeq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><a href="#local-6989586621679241058"><span class="hs-identifier hs-var">uniBonds</span></a><span>
</span><a name="line-316"></a><span>          </span><a name="local-6989586621679241060"><a href="#local-6989586621679241060"><span class="hs-identifier">bondsForth</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Molecule.Util.html#groupTupleSeq"><span class="hs-identifier hs-var">groupTupleSeq</span></a><span> </span><a href="#local-6989586621679241059"><span class="hs-identifier hs-var">bondTupleSeq</span></a><span>
</span><a name="line-317"></a><span>          </span><a name="local-6989586621679241061"><a href="#local-6989586621679241061"><span class="hs-identifier">bondsBack</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Molecule.Util.html#groupTupleSeq"><span class="hs-identifier hs-var">groupTupleSeq</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">swap</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679241059"><span class="hs-identifier hs-var">bondTupleSeq</span></a><span>
</span><a name="line-318"></a><span>          </span><a name="local-6989586621679241062"><a href="#local-6989586621679241062"><span class="hs-identifier">bonds</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679241060"><span class="hs-identifier hs-var">bondsForth</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679241061"><span class="hs-identifier hs-var">bondsBack</span></a><span>
</span><a name="line-319"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679241062"><span class="hs-identifier hs-var">bonds</span></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier">parsePDB</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-322"></a><a name="parsePDB"><a href="Spicy.Parser.html#parsePDB"><span class="hs-identifier">parsePDB</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-comment">{-|
Parser for the Spicy format used in this program. Represents fully all informations stored in the
'Molecule' type.
-}</span><span>
</span><a name="line-328"></a><span class="hs-identifier">parseSpicy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-329"></a><a name="parseSpicy"><a href="Spicy.Parser.html#parseSpicy"><span class="hs-identifier">parseSpicy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-comment">{- do
  _ &lt;- string &quot;#Spicy-Format v0.2&quot;
  endOfLine
  skipSpace
  _ &lt;- string &quot;#Spicy-Molecule&quot;
  endOfLine
  _ &lt;- string &quot;  Label:&quot;
  endOfLine
  _ &lt;- string &quot;    &quot;
  mLabel &lt;- takeTill isEndOfLine
  skipSpace
  mEnergy &lt;- maybeOption parseEnergy
  mGradient &lt;- maybeOption parseGradient
  mHessian &lt;- maybeOption parseHessian
  skipSpace
  _ &lt;- string &quot;#Spicy-Atoms&quot;
  skipSpace
  mAtoms &lt;- many1 parseAtoms
  return Molecule
    { _molecule_Label    = TS.unpack mLabel
    , _molecule_Atoms    = R.fromList (R.Z R.:. length mAtoms) mAtoms
    , _molecule_Energy   = mEnergy
    , _molecule_Gradient = mGradient
    , _molecule_Hessian  = mHessian
    }
  where
    parseEnergy = do
      _ &lt;- manyTill anyChar (string &quot;Energy / Hartree:&quot;)
      skipSpace
      energy &lt;- double
      return energy
    parseGradient = do
      _ &lt;- manyTill anyChar (string &quot;Gradient / Hartee/Bohr:&quot;)
      skipSpace
      gradient &lt;- many1 $ do
        skipSpace
        gVal &lt;- double
        return gVal
      return $ R.fromListUnboxed (R.Z R.:. (length gradient)) gradient
    parseHessian = do
      _ &lt;- manyTill anyChar (string &quot;Hessian / a.u.:&quot;)
      skipSpace
      hessian &lt;- parseHMatrix
      return hessian
    parseAtoms = do
      -- indendation
      _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
      -- chemical element
      cElement &lt;- many1 letter
      --
      _ &lt;- count 4 (char ' ')
      -- label of the atom
      label &lt;- count 6 anyChar

      --
      _ &lt;- count 4 (char ' ')
      -- pseudo label
      pseudo &lt;- anyChar
      --
      _ &lt;- count 4 (char ' ')
      -- FFType
      ffType &lt;- count 6 anyChar
      pChargeTest &lt;- maybeOption $ do
        skipSpace
        (string &quot;No&quot;)
      pCharge &lt;- if pChargeTest == Nothing
        then Just &lt;$&gt; do
          _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
          double
        else return Nothing
      _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
      coordVec &lt;- count 3 $ do
        coordComponent &lt;- double
        _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
        return coordComponent
      _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
      connectivity &lt;- many' $ do
        conAtom &lt;- decimal
        _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
        return conAtom
      endOfLine
      return Atom
        { _atom_Element      = read cElement
        , _atom_Label        = T.unpack . T.strip . T.pack $ label
        , _atom_IsPseudo     = if pseudo == 'P' then True else False
        , _atom_FFType       = T.unpack . T.strip . T.pack $ ffType
        , _atom_PCharge      = pCharge
        , _atom_Coordinates  = R.fromListUnboxed (R.Z R.:. 3) coordVec
        , _atom_Connectivity = I.fromList connectivity
        }
-}</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">----------------------------------------------------------------------------------------------------</span><span>
</span><a name="line-422"></a><span class="hs-comment">{-|
Parse the &quot;show&quot; instance output for HMatrix' matrix Type, including the dimension infos
-}</span><span>
</span><a name="line-425"></a><span class="hs-identifier">parseHMatrix</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">A.Matrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><a name="parseHMatrix"><a href="Spicy.Parser.html#parseHMatrix"><span class="hs-identifier">parseHMatrix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-comment">{- do
  skipSpace
  _ &lt;- char '('
  dimX &lt;- decimal
  _ &lt;- char '&gt;'
  _ &lt;- char '&lt;'
  dimY &lt;- decimal
  _ &lt;- char ')'
  skipSpace
  _ &lt;- char '['
  _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
  rows &lt;- do
    count dimX $ do
      singleRow &lt;- count dimY parseElement
      skipSpace
      return singleRow
  _ &lt;- char ']'
  --return $ fromRows . map fromList $ rows
  return $ R.fromListUnboxed (R.Z R.:. dimX R.:. dimY) . concat $ rows
  where
    parseElement :: Parser Double
    parseElement = do
      _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
      _ &lt;- option ',' (char ',')
      _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
      element &lt;- double
      _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
      _ &lt;- option ',' (char ',')
      _ &lt;- many' (char ' ' &lt;|&gt; char '\t')
      return element
-}</span><span>
</span><a name="line-457"></a></pre></body></html>