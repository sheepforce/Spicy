<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Spicy.Molecule.Util
Description : Utilities to manipulate basic molecular data structures.
Copyright   : Phillip Seeber, 2019
License     : GPL-3
Maintainer  : phillip.seeber@uni-jena.de
Stability   : experimental
Portability : POSIX, Windows

This module provides functions to manipulate basic data structures of 'Molecule's, such as indexing.
-}</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Spicy.Molecule.Util</span><span>
</span><a name="line-13"></a><span class="hs-special">(</span><span> </span><a href="Spicy.Molecule.Util.html#checkMolecule"><span class="hs-identifier hs-var">checkMolecule</span></a><span>
</span><a name="line-14"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Molecule.Util.html#reIndexMolecule"><span class="hs-identifier hs-var">reIndexMolecule</span></a><span>
</span><a name="line-15"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Molecule.Util.html#groupTupleSeq"><span class="hs-identifier hs-var">groupTupleSeq</span></a><span>
</span><a name="line-16"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Molecule.Util.html#groupBy"><span class="hs-identifier hs-var">groupBy</span></a><span>
</span><a name="line-17"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IntMap.Lazy</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap.Lazy</span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IntSet</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">\\</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntSet</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Sequence</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Sequence</span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Lens.Micro.Platform</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>             </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cycle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">head</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">init</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>                                      </span><span class="hs-identifier hs-var">last</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">maximum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">minimum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tail</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">take</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>                                      </span><span class="hs-identifier hs-var">takeWhile</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">!!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Types.html"><span class="hs-identifier">Spicy.Types</span></a><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-comment">{-
&quot;IS&quot; = IntSet
&quot;IM&quot; = IntMap
&quot;oK&quot; = old key
&quot;nK&quot; = new key
&quot;RI&quot; = replaced index
&quot;oS&quot; = old set
&quot;nS&quot; = new set
&quot;oA&quot; = old atom
&quot;nA&quot; = new atom
&quot;sM&quot; = sub molecules
&quot;nL&quot; = next layer
&quot;pA&quot; = pseudo atoms
-}</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">{-|
Check if a single 'Molecule' layer has sane indices ('IM.Key') in the 'IntMap' for '_molecule_Atoms'
and '_molecule_SubMol', meaning the bonds do not include 'Atom's, that do not exist. Then
recursively check if the 'Atom's of deeper layers are proper subsets of the higher layer, both for
'_molecule_Atoms' and '_molecule_Bonds'. Also checks if fragments of the same layer are disjoint.
Returns the 'Molecule' without modifications if it is sane, a string with description of the found
problem otherwise. This check is exhaustive and potentially expensive.
-}</span><span>
</span><a name="line-55"></a><span class="hs-identifier">checkMolecule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-56"></a><a name="checkMolecule"><a href="Spicy.Molecule.Util.html#checkMolecule"><span class="hs-identifier">checkMolecule</span></a></a><span> </span><a name="local-6989586621679187915"><a href="#local-6989586621679187915"><span class="hs-identifier">mol</span></a></a><span>
</span><a name="line-57"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679187919"><span class="hs-identifier hs-var">layerIndCheck</span></a><span>      </span><span class="hs-glyph">=</span><span>
</span><a name="line-58"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;checkMolecule: Bonds vs Atoms mismatch. Your bonds bind to non existing atoms.&quot;</span><span>
</span><a name="line-59"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679187922"><span class="hs-identifier hs-var">fragAtomsDisjCheck</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-60"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;checkMolecule: The atoms of deeper layers are not disjoint but shared by fragments.&quot;</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679187926"><span class="hs-identifier hs-var">subsetCheckAtoms</span></a><span>   </span><span class="hs-glyph">=</span><span>
</span><a name="line-62"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;checkMolecule: The atoms of deeper layers are not a subset of this layer.&quot;</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span>
</span><a name="line-64"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">S.null</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_SubMol"><span class="hs-identifier hs-var">molecule_SubMol</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span>
</span><a name="line-66"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-67"></a><span>          </span><a name="local-6989586621679188562"><a href="#local-6989586621679188562"><span class="hs-identifier">subMols</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Spicy.Molecule.Util.html#checkMolecule"><span class="hs-identifier hs-var">checkMolecule</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_SubMol"><span class="hs-identifier hs-var">molecule_SubMol</span></a><span>
</span><a name="line-68"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Spicy.Types.html#molecule_SubMol"><span class="hs-identifier hs-var">molecule_SubMol</span></a><span> </span><span class="hs-operator hs-var">.~</span><span> </span><a href="#local-6989586621679188562"><span class="hs-identifier hs-var">subMols</span></a><span>
</span><a name="line-69"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-comment">-- Indices of the atoms</span><span>
</span><a name="line-71"></a><span>    </span><a name="local-6989586621679187916"><a href="#local-6989586621679187916"><span class="hs-identifier">atomInds</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span>
</span><a name="line-72"></a><span>    </span><span class="hs-comment">-- Indices of the bond origin atoms</span><span>
</span><a name="line-73"></a><span>    </span><a name="local-6989586621679187917"><a href="#local-6989586621679187917"><span class="hs-identifier">bondsOrig</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Bonds"><span class="hs-identifier hs-var">molecule_Bonds</span></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- Indices of the bond target atoms</span><span>
</span><a name="line-75"></a><span>    </span><a name="local-6989586621679187918"><a href="#local-6989586621679187918"><span class="hs-identifier">bondsTarget</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IS.unions</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Bonds"><span class="hs-identifier hs-var">molecule_Bonds</span></a><span>
</span><a name="line-76"></a><span>    </span><span class="hs-comment">-- Check if bond indices do not exceed atom indices.</span><span>
</span><a name="line-77"></a><span>    </span><a name="local-6989586621679187919"><a href="#local-6989586621679187919"><span class="hs-identifier">layerIndCheck</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IS.null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679187917"><span class="hs-identifier hs-var">bondsOrig</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">IS.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679187918"><span class="hs-identifier hs-var">bondsTarget</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679187916"><span class="hs-identifier hs-var">atomInds</span></a><span>
</span><a name="line-78"></a><span>    </span><span class="hs-comment">-- Next layer molecules</span><span>
</span><a name="line-79"></a><span>    </span><a name="local-6989586621679187920"><a href="#local-6989586621679187920"><span class="hs-identifier">sM</span></a></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679187915"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_SubMol"><span class="hs-identifier hs-var">molecule_SubMol</span></a><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621679187921"><a href="#local-6989586621679187921"><span class="hs-identifier">sMSize</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.length</span><span> </span><a href="#local-6989586621679187920"><span class="hs-identifier hs-var">sM</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-comment">-- Disjointment test (no atoms and bonds shared through fragments)</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-comment">-- &quot;bA&quot; = Bool_A, &quot;aA&quot; = Atoms_A</span><span>
</span><a name="line-83"></a><span>    </span><a name="local-6989586621679187922"><a href="#local-6989586621679187922"><span class="hs-identifier">fragAtomsDisjCheck</span></a></a><span>   </span><span class="hs-glyph">=</span><span>
</span><a name="line-84"></a><span>        </span><span class="hs-identifier hs-var">fst</span><span>
</span><a name="line-85"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679188154"><a href="#local-6989586621679188154"><span class="hs-identifier">bA</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679188155"><a href="#local-6989586621679188155"><span class="hs-identifier">aA</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679188156"><a href="#local-6989586621679188156"><span class="hs-identifier">aB</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-86"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679188155"><span class="hs-identifier hs-var">aA</span></a><span> </span><span class="hs-special">`</span><a href="Spicy.Molecule.Util.html#iMdisjoint"><span class="hs-identifier hs-var">iMdisjoint</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679188156"><span class="hs-identifier hs-var">aB</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679188154"><span class="hs-identifier hs-var">bA</span></a><span>
</span><a name="line-87"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679188155"><span class="hs-identifier hs-var">aA</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">IM.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679188156"><span class="hs-identifier hs-var">aB</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679188155"><span class="hs-identifier hs-var">aA</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.replicate</span><span> </span><a href="#local-6989586621679187921"><span class="hs-identifier hs-var">sMSize</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>      </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187920"><span class="hs-identifier hs-var">sM</span></a><span>
</span><a name="line-93"></a><span>    </span><span class="hs-comment">-- Next Layer atoms all joined</span><span>
</span><a name="line-94"></a><span>    </span><a name="local-6989586621679187923"><a href="#local-6989586621679187923"><span class="hs-identifier">nLAtoms</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.unions</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187920"><span class="hs-identifier hs-var">sM</span></a><span>
</span><a name="line-95"></a><span>    </span><a name="local-6989586621679187924"><a href="#local-6989586621679187924"><span class="hs-identifier">nLAtomsInds</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><a href="#local-6989586621679187923"><span class="hs-identifier hs-var">nLAtoms</span></a><span>
</span><a name="line-96"></a><span>    </span><span class="hs-comment">-- All pseudo atoms of the next layer set</span><span>
</span><a name="line-97"></a><span>    </span><a name="local-6989586621679187925"><a href="#local-6989586621679187925"><span class="hs-identifier">nLPseudoAtomsInds</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">IM.filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#atom_IsPseudo"><span class="hs-identifier hs-var">atom_IsPseudo</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679187923"><span class="hs-identifier hs-var">nLAtoms</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-comment">-- Test if the next deeper layer is a proper subset of the current layer.</span><span>
</span><a name="line-99"></a><span>    </span><a name="local-6989586621679187926"><a href="#local-6989586621679187926"><span class="hs-identifier">subsetCheckAtoms</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IS.null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679187924"><span class="hs-identifier hs-var">nLAtomsInds</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679187925"><span class="hs-identifier hs-var">nLPseudoAtomsInds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679187916"><span class="hs-identifier hs-var">atomInds</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-comment">{-
    -- This check doesn't need to be true, as pseudobonds can break the subset property.
    -- All Bonds of the next layer joinded
    nLBonds              = IM.unions . VB.map (^. molecule_Bonds) $ sM
    -- Exclude bonds from and to pseudo atoms in deeper layers
    nLBondsOrigin        = IM.keysSet nLBonds \\ nLPseudoAtomsInds
    nLBondsTarget        = IS.unions nLBonds \\ nLPseudoAtomsInds
    subsetCheckBonds     =
      (nLBondsOrigin `IS.union` nLBondsTarget) \\ (bondsTarget `IS.union` bondsOrig)
    -}</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">{-|
Check if 2 'IntMap' are disjoint in their 'IM.Key's.
-}</span><span>
</span><a name="line-114"></a><span class="hs-identifier">iMdisjoint</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-115"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><a href="#local-6989586621679187913"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><a href="#local-6989586621679187914"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-117"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-118"></a><a name="iMdisjoint"><a href="Spicy.Molecule.Util.html#iMdisjoint"><span class="hs-identifier">iMdisjoint</span></a></a><span> </span><a name="local-6989586621679188576"><a href="#local-6989586621679188576"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679188577"><a href="#local-6989586621679188577"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679188576"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">IM.intersection</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679188577"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">{-|
Reindex a complete 'Molecule', including all its deeper layers in '_molecule_SubMol') by mappings
from a global replacement Map, mapping old to new indices. This function assumes, that your molecule
is sane in the overall assumptions of this program. This means that the lower layers obey the
counting scheme of the atoms of the higher layers and pseudoatoms come last.
-}</span><span>
</span><a name="line-126"></a><span class="hs-identifier">reIndexMolecule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-127"></a><a name="reIndexMolecule"><a href="Spicy.Molecule.Util.html#reIndexMolecule"><span class="hs-identifier">reIndexMolecule</span></a></a><span> </span><a name="local-6989586621679188578"><a href="#local-6989586621679188578"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188579"><a href="#local-6989586621679188579"><span class="hs-identifier">mol</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-128"></a><span>  </span><span class="hs-comment">-- Get the submolecules</span><span>
</span><a name="line-129"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679188580"><a href="#local-6989586621679188580"><span class="hs-identifier">subMols</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679188579"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_SubMol"><span class="hs-identifier hs-var">molecule_SubMol</span></a><span>
</span><a name="line-130"></a><span>  </span><span class="hs-comment">-- Reindex the current layer only</span><span>
</span><a name="line-131"></a><span>  </span><a name="local-6989586621679188581"><a href="#local-6989586621679188581"><span class="hs-identifier">molRI</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Molecule.Util.html#reIndexMoleculeLayer"><span class="hs-identifier hs-var">reIndexMoleculeLayer</span></a><span> </span><a href="#local-6989586621679188578"><span class="hs-identifier hs-var">repMap</span></a><span> </span><a href="#local-6989586621679188579"><span class="hs-identifier hs-var">mol</span></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-comment">-- If the molecule has no submolecules:</span><span>
</span><a name="line-133"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">S.null</span><span> </span><a href="#local-6989586621679188580"><span class="hs-identifier hs-var">subMols</span></a><span>
</span><a name="line-134"></a><span>    </span><span class="hs-comment">-- Then we are done.</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679188581"><span class="hs-identifier hs-var">molRI</span></a><span>
</span><a name="line-136"></a><span>    </span><span class="hs-comment">-- Else we need to reindex the deeper layers also.</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-138"></a><span>      </span><a name="local-6989586621679188582"><a href="#local-6989586621679188582"><span class="hs-identifier">subMolsRI</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><a href="Spicy.Molecule.Util.html#reIndexMolecule"><span class="hs-identifier hs-var">reIndexMolecule</span></a><span> </span><a href="#local-6989586621679188578"><span class="hs-identifier hs-var">repMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679188580"><span class="hs-identifier hs-var">subMols</span></a><span>
</span><a name="line-139"></a><span>      </span><a href="Spicy.Molecule.Util.html#reIndexMolecule"><span class="hs-identifier hs-var">reIndexMolecule</span></a><span> </span><a href="#local-6989586621679188578"><span class="hs-identifier hs-var">repMap</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679188581"><span class="hs-identifier hs-var">molRI</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Spicy.Types.html#molecule_SubMol"><span class="hs-identifier hs-var">molecule_SubMol</span></a><span> </span><span class="hs-operator hs-var">.~</span><span> </span><a href="#local-6989586621679188582"><span class="hs-identifier hs-var">subMolsRI</span></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-comment">{-|
Reindex the '_molecule_Atoms' and '_molecule_Bonds' of a single layer of a molecule (ignoring
anything in the '_molecule_SubMol' field). While the completeness of the reindexing is checked and
incompleteness of the replacement 'IntMap' 'Int' will result in 'Left' 'String', it is not checked
if the 'Atom''s indexing is sane and indices are unique.
-}</span><span>
</span><a name="line-147"></a><span class="hs-identifier">reIndexMoleculeLayer</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-148"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span>             </span><span class="hs-comment">-- ^ 'IntMap' with mappings from old indices to new indices (bonds and</span><span>
</span><a name="line-149"></a><span>                            </span><span class="hs-comment">--   atoms).</span><span>
</span><a name="line-150"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>               </span><span class="hs-comment">-- ^ Molecule to reindex.</span><span>
</span><a name="line-151"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-comment">-- ^ 'Left' 'String' in case the mapping from old keys to new keys is</span><span>
</span><a name="line-152"></a><span>                            </span><span class="hs-comment">--   incomplete.</span><span>
</span><a name="line-153"></a><a name="reIndexMoleculeLayer"><a href="Spicy.Molecule.Util.html#reIndexMoleculeLayer"><span class="hs-identifier">reIndexMoleculeLayer</span></a></a><span> </span><a name="local-6989586621679188583"><a href="#local-6989586621679188583"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188584"><a href="#local-6989586621679188584"><span class="hs-identifier">mol</span></a></a><span>
</span><a name="line-154"></a><span>  </span><span class="hs-comment">-- If old Atom indices cannot be completely replaced by the Map:</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Molecule.Util.html#checkRepMapCompleteIS"><span class="hs-identifier hs-var">checkRepMapCompleteIS</span></a><span> </span><a href="#local-6989586621679188583"><span class="hs-identifier hs-var">repMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679188584"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-156"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;reIndexMoleculeLayer: The remapping of indices is not complete for the atom indices.&quot;</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-comment">-- If old bond type data cannot be completely replaced by the Map:</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Molecule.Util.html#checkRepMapCompleteIMIS"><span class="hs-identifier hs-var">checkRepMapCompleteIMIS</span></a><span> </span><a href="#local-6989586621679188583"><span class="hs-identifier hs-var">repMap</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679188584"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Bonds"><span class="hs-identifier hs-var">molecule_Bonds</span></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span>
</span><a name="line-159"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;reIndexMoleculeLayer: The remapping of indices is not complete for the bond data.&quot;</span><span>
</span><a name="line-160"></a><span>  </span><span class="hs-comment">-- If both checks went fine:</span><span>
</span><a name="line-161"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                                               </span><span class="hs-glyph">=</span><span>
</span><a name="line-162"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679188584"><span class="hs-identifier hs-var">mol</span></a><span>
</span><a name="line-163"></a><span>        </span><span class="hs-comment">-- Use the (%~) lens to update the atoms indices of a molecule with new indices.</span><span>
</span><a name="line-164"></a><span>        </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span> </span><span class="hs-operator hs-var">%~</span><span> </span><a href="Spicy.Molecule.Util.html#replaceIMKeys"><span class="hs-identifier hs-var">replaceIMKeys</span></a><span> </span><a href="#local-6989586621679188583"><span class="hs-identifier hs-var">repMap</span></a><span>
</span><a name="line-165"></a><span>        </span><span class="hs-comment">-- Use the (%~) lens to update keys and values (IntSet) of the bond type data structure.</span><span>
</span><a name="line-166"></a><span>        </span><span class="hs-operator hs-var">&amp;</span><span> </span><a href="Spicy.Types.html#molecule_Bonds"><span class="hs-identifier hs-var">molecule_Bonds</span></a><span> </span><span class="hs-operator hs-var">%~</span><span> </span><a href="Spicy.Molecule.Util.html#replaceIMIS"><span class="hs-identifier hs-var">replaceIMIS</span></a><span> </span><a href="#local-6989586621679188583"><span class="hs-identifier hs-var">repMap</span></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">{-|
Check if 'IntMap' is complete to replace all values in an 'IntSet' (any old 'IS.Key' can be replaced
by a new 'IS.Key').  Gives 'True' if complete, 'False' if the replacement 'IntMap' 'Int' has holes.
-}</span><span>
</span><a name="line-172"></a><span class="hs-identifier">checkRepMapCompleteIS</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-173"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ 'IntMap' containing the mapping from old 'IS.Key's to new 'IS.Key's.</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span>     </span><span class="hs-comment">-- ^ 'IntSet' in which values should be replaced.</span><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>       </span><span class="hs-comment">-- ^ Result.</span><span>
</span><a name="line-176"></a><a name="checkRepMapCompleteIS"><a href="Spicy.Molecule.Util.html#checkRepMapCompleteIS"><span class="hs-identifier">checkRepMapCompleteIS</span></a></a><span> </span><a name="local-6989586621679188585"><a href="#local-6989586621679188585"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188586"><a href="#local-6989586621679188586"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-177"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Keys, that can be replaced</span><span>
</span><a name="line-178"></a><span>      </span><a name="local-6989586621679188587"><a href="#local-6989586621679188587"><span class="hs-identifier">repKeys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><a href="#local-6989586621679188585"><span class="hs-identifier hs-var">repMap</span></a><span>
</span><a name="line-179"></a><span>      </span><span class="hs-comment">-- Keys that shall be replaced minus keys that can be replaced</span><span>
</span><a name="line-180"></a><span>      </span><a name="local-6989586621679188588"><a href="#local-6989586621679188588"><span class="hs-identifier">lostKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679188586"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679188587"><span class="hs-identifier hs-var">repKeys</span></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">IS.null</span><span> </span><a href="#local-6989586621679188588"><span class="hs-identifier hs-var">lostKeys</span></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">{-|
Check if 'IntMap' is complete to replace all 'IM.Key's from the old 'IntMap' by new 'IM.Key's. Gives
'True' if the 'IntMap' with replacements is complete and 'False' otherwise.
-}</span><span>
</span><a name="line-187"></a><span class="hs-identifier">checkRepMapCompleteIM</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-188"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ 'IntMap' containing the mapping from old 'IS.Key's to new 'IS.Key's.</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><a href="#local-6989586621679187912"><span class="hs-identifier hs-type">a</span></a><span>   </span><span class="hs-comment">-- ^ 'IntMap' in which 'IM.Key's should be replaced.</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>       </span><span class="hs-comment">-- ^ Result.</span><span>
</span><a name="line-191"></a><a name="checkRepMapCompleteIM"><a href="Spicy.Molecule.Util.html#checkRepMapCompleteIM"><span class="hs-identifier">checkRepMapCompleteIM</span></a></a><span> </span><a name="local-6989586621679188589"><a href="#local-6989586621679188589"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188590"><a href="#local-6989586621679188590"><span class="hs-identifier">im</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-192"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Keys, that can be replaced</span><span>
</span><a name="line-193"></a><span>      </span><a name="local-6989586621679188591"><a href="#local-6989586621679188591"><span class="hs-identifier">repKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><a href="#local-6989586621679188589"><span class="hs-identifier hs-var">repMap</span></a><span>
</span><a name="line-194"></a><span>      </span><span class="hs-comment">-- Keys that shall be replaced</span><span>
</span><a name="line-195"></a><span>      </span><a name="local-6989586621679188592"><a href="#local-6989586621679188592"><span class="hs-identifier">oldKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.keysSet</span><span> </span><a href="#local-6989586621679188590"><span class="hs-identifier hs-var">im</span></a><span>
</span><a name="line-196"></a><span>      </span><span class="hs-comment">-- Keys that cannot be replaced</span><span>
</span><a name="line-197"></a><span>      </span><a name="local-6989586621679188593"><a href="#local-6989586621679188593"><span class="hs-identifier">lostKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679188592"><span class="hs-identifier hs-var">oldKeys</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679188591"><span class="hs-identifier hs-var">repKeys</span></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">IS.null</span><span> </span><a href="#local-6989586621679188593"><span class="hs-identifier hs-var">lostKeys</span></a><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-comment">{-|
Check if 'IntMap' is complete to replace all values in an 'IntMap' 'InSet' type construction
(replacing both the lookup keys in the 'IntMap', as well as all values in the 'IntSet'). Gives
'True' if complete and 'False' otherwise.
-}</span><span>
</span><a name="line-206"></a><span class="hs-identifier">checkRepMapCompleteIMIS</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-207"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span>    </span><span class="hs-comment">-- ^ 'IntMap' containing the mapping from old 'IS.Key's to new 'IS.Key's.</span><span>
</span><a name="line-208"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span> </span><span class="hs-comment">-- ^ 'IntMap' 'IntSet' in which values and keys should be replaced.</span><span>
</span><a name="line-209"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>          </span><span class="hs-comment">-- ^ Result.</span><span>
</span><a name="line-210"></a><a name="checkRepMapCompleteIMIS"><a href="Spicy.Molecule.Util.html#checkRepMapCompleteIMIS"><span class="hs-identifier">checkRepMapCompleteIMIS</span></a></a><span> </span><a name="local-6989586621679188594"><a href="#local-6989586621679188594"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188595"><a href="#local-6989586621679188595"><span class="hs-identifier">imis</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- All values, that appear in the union of all IntSet</span><span>
</span><a name="line-212"></a><span>      </span><a name="local-6989586621679188596"><a href="#local-6989586621679188596"><span class="hs-identifier">oldSets</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IS.unions</span><span> </span><a href="#local-6989586621679188595"><span class="hs-identifier hs-var">imis</span></a><span>
</span><a name="line-213"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><a href="Spicy.Molecule.Util.html#checkRepMapCompleteIM"><span class="hs-identifier hs-var">checkRepMapCompleteIM</span></a><span> </span><a href="#local-6989586621679188594"><span class="hs-identifier hs-var">repMap</span></a><span> </span><a href="#local-6989586621679188595"><span class="hs-identifier hs-var">imis</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Spicy.Molecule.Util.html#checkRepMapCompleteIS"><span class="hs-identifier hs-var">checkRepMapCompleteIS</span></a><span> </span><a href="#local-6989586621679188594"><span class="hs-identifier hs-var">repMap</span></a><span> </span><a href="#local-6989586621679188596"><span class="hs-identifier hs-var">oldSets</span></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">{-|
Replace all 'IS.Key's from an 'IntSet' according to mappings from an 'IntMap' 'Int'. Entries, that
cannot be found in the 'IntMap' will no be changed.
-}</span><span>
</span><a name="line-219"></a><span class="hs-identifier">replaceIS</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-220"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ 'IntMap' containing the mapping from old 'IS.Key's to new 'IS.Key's.</span><span>
</span><a name="line-221"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span>     </span><span class="hs-comment">-- ^ 'IntSet' to be modified.</span><span>
</span><a name="line-222"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span>     </span><span class="hs-comment">-- ^ Resulting new 'IntSet'.</span><span>
</span><a name="line-223"></a><a name="replaceIS"><a href="Spicy.Molecule.Util.html#replaceIS"><span class="hs-identifier">replaceIS</span></a></a><span> </span><a name="local-6989586621679188597"><a href="#local-6989586621679188597"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188598"><a href="#local-6989586621679188598"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-224"></a><span>  </span><span class="hs-identifier hs-var">IS.map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679188599"><a href="#local-6989586621679188599"><span class="hs-identifier">oK</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679188600"><a href="#local-6989586621679188600"><span class="hs-identifier">nK</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679188597"><span class="hs-identifier hs-var">repMap</span></a><span> </span><span class="hs-operator hs-var">IM.!?</span><span> </span><a href="#local-6989586621679188599"><span class="hs-identifier hs-var">oK</span></a><span>
</span><a name="line-226"></a><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621679188599"><span class="hs-identifier hs-var">oK</span></a><span> </span><a href="#local-6989586621679188600"><span class="hs-identifier hs-var">nK</span></a><span>
</span><a name="line-227"></a><span>  </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679188598"><span class="hs-identifier hs-var">is</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">{-|
Replace all 'IM.Key's in an 'IntMap' according to mappings from an 'IntMap' 'Int'. Entries that
cannot be found in the 'IntMap' will not be changed.
-}</span><span>
</span><a name="line-233"></a><span class="hs-identifier">replaceIMKeys</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-234"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ 'IntMap' containing the mapping from old 'IM.Key's to new 'IM.Key's.</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><a href="#local-6989586621679187911"><span class="hs-identifier hs-type">a</span></a><span>   </span><span class="hs-comment">-- ^ 'IntMap' in which 'IM.Key's shall be replaced.</span><span>
</span><a name="line-236"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><a href="#local-6989586621679187911"><span class="hs-identifier hs-type">a</span></a><span>   </span><span class="hs-comment">-- ^ Resulting new 'IntMap' with replaced 'IM.Key's.</span><span>
</span><a name="line-237"></a><a name="replaceIMKeys"><a href="Spicy.Molecule.Util.html#replaceIMKeys"><span class="hs-identifier">replaceIMKeys</span></a></a><span> </span><a name="local-6989586621679188601"><a href="#local-6989586621679188601"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188602"><a href="#local-6989586621679188602"><span class="hs-identifier">im</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-238"></a><span>  </span><span class="hs-identifier hs-var">IM.mapKeys</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679188603"><a href="#local-6989586621679188603"><span class="hs-identifier">oK</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-239"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679188604"><a href="#local-6989586621679188604"><span class="hs-identifier">nK</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679188601"><span class="hs-identifier hs-var">repMap</span></a><span> </span><span class="hs-operator hs-var">IM.!?</span><span> </span><a href="#local-6989586621679188603"><span class="hs-identifier hs-var">oK</span></a><span>
</span><a name="line-240"></a><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621679188603"><span class="hs-identifier hs-var">oK</span></a><span> </span><a href="#local-6989586621679188604"><span class="hs-identifier hs-var">nK</span></a><span>
</span><a name="line-241"></a><span>  </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679188602"><span class="hs-identifier hs-var">im</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-comment">{-|
Replace all lookup-'IM.Key's of an 'IntMap' 'IntSet' and all values in the 'IntSet' by a given
mapping from an 'IntMap'. Entries that cannot be found in the 'IntMap' will not be changed.
-}</span><span>
</span><a name="line-247"></a><span class="hs-identifier">replaceIMIS</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-248"></a><span>     </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">Int</span><span>    </span><span class="hs-comment">-- ^ 'IntMap' containing the mapping from old 'IS.Key's to new 'IS.Key's.</span><span>
</span><a name="line-249"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span> </span><span class="hs-comment">-- ^ Original structure, which to replace both keys and values.</span><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span> </span><span class="hs-comment">-- ^ modified structure.</span><span>
</span><a name="line-251"></a><a name="replaceIMIS"><a href="Spicy.Molecule.Util.html#replaceIMIS"><span class="hs-identifier">replaceIMIS</span></a></a><span> </span><a name="local-6989586621679188605"><a href="#local-6989586621679188605"><span class="hs-identifier">repMap</span></a></a><span> </span><a name="local-6989586621679188606"><a href="#local-6989586621679188606"><span class="hs-identifier">imis</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-252"></a><span>  </span><span class="hs-comment">-- Replace all values in all IntSet</span><span>
</span><a name="line-253"></a><span>    </span><span class="hs-identifier hs-var">IM.map</span><span> </span><span class="hs-special">(</span><a href="Spicy.Molecule.Util.html#replaceIS"><span class="hs-identifier hs-var">replaceIS</span></a><span> </span><a href="#local-6989586621679188605"><span class="hs-identifier hs-var">repMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-comment">-- Replace all lookup keys</span><span>
</span><a name="line-255"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Spicy.Molecule.Util.html#replaceIMKeys"><span class="hs-identifier hs-var">replaceIMKeys</span></a><span> </span><a href="#local-6989586621679188605"><span class="hs-identifier hs-var">repMap</span></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679188606"><span class="hs-identifier hs-var">imis</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">{-|
Group by the first tuple element and within this group build an IntSet of the the second tuple
elements.
-}</span><span>
</span><a name="line-262"></a><span class="hs-identifier">groupTupleSeq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span>
</span><a name="line-263"></a><a name="groupTupleSeq"><a href="Spicy.Molecule.Util.html#groupTupleSeq"><span class="hs-identifier">groupTupleSeq</span></a></a><span> </span><a name="local-6989586621679188607"><a href="#local-6989586621679188607"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Build groups of tuples with same keys.</span><span>
</span><a name="line-265"></a><span>      </span><span class="hs-identifier">keyValGroups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>      </span><a name="local-6989586621679188608"><a href="#local-6989586621679188608"><span class="hs-identifier">keyValGroups</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Molecule.Util.html#groupBy"><span class="hs-identifier hs-var">groupBy</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679188611"><a href="#local-6989586621679188611"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679188612"><a href="#local-6989586621679188612"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679188611"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679188612"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.sortOn</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679188607"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-267"></a><span>      </span><span class="hs-comment">-- Transform the grouped key value structures to a Seq (IntMap IntSet), where each IntMap has</span><span>
</span><a name="line-268"></a><span>      </span><span class="hs-comment">-- just one key.</span><span>
</span><a name="line-269"></a><span>      </span><span class="hs-identifier">atomicIntMaps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>      </span><a name="local-6989586621679188609"><a href="#local-6989586621679188609"><span class="hs-identifier">atomicIntMaps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Spicy.Molecule.Util.html#imisFromGroupedSequence"><span class="hs-identifier hs-var">imisFromGroupedSequence</span></a><span> </span><a href="#local-6989586621679188608"><span class="hs-identifier hs-var">keyValGroups</span></a><span>
</span><a name="line-271"></a><span>      </span><span class="hs-comment">-- Fold all atom IntMap in the sequence into one.</span><span>
</span><a name="line-272"></a><span>      </span><a name="local-6989586621679188610"><a href="#local-6989586621679188610"><span class="hs-identifier">completeMap</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679188609"><span class="hs-identifier hs-var">atomicIntMaps</span></a><span>
</span><a name="line-273"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><span class="hs-comment">-- The only way this function can fail, is if keys would not properly be groupled. This cannot</span><span>
</span><a name="line-274"></a><span>      </span><span class="hs-comment">-- happen if 'groupBy' is called correclty before 'imisFromGroupedSequence'. Therefore default</span><span>
</span><a name="line-275"></a><span>      </span><span class="hs-comment">-- to the empty IntMap if this case, that cannot happen, happens.</span><span>
</span><a name="line-276"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679188610"><span class="hs-identifier hs-var">completeMap</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-277"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span>
</span><a name="line-278"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679188847"><a href="#local-6989586621679188847"><span class="hs-identifier">im</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679188847"><span class="hs-identifier hs-var">im</span></a><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-comment">{-|
Create the IntMap IntSet structure from a group of 'IM.Key' value pairs. This means, that the first
elements of the tuple, all need to be the same 'IM.key'. If they are not the assumptions of this
function are not met and a 'Left' 'String' as error will be returned. The result will be an IntMap
with a single 'IM.Key'.
-}</span><span>
</span><a name="line-286"></a><span class="hs-identifier">imisFromGroupedSequence</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><a name="imisFromGroupedSequence"><a href="Spicy.Molecule.Util.html#imisFromGroupedSequence"><span class="hs-identifier">imisFromGroupedSequence</span></a></a><span> </span><a name="local-6989586621679188848"><a href="#local-6989586621679188848"><span class="hs-identifier">group</span></a></a><span>
</span><a name="line-288"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S.null</span><span> </span><a href="#local-6989586621679188848"><span class="hs-identifier hs-var">group</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span>
</span><a name="line-289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679188852"><span class="hs-identifier hs-var">keyCheck</span></a><span>     </span><span class="hs-glyph">=</span><span>
</span><a name="line-290"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679188851"><span class="hs-identifier hs-var">headKey</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-291"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span>
</span><a name="line-292"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679188854"><a href="#local-6989586621679188854"><span class="hs-identifier">k</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679188854"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679188853"><span class="hs-identifier hs-var">values</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span>
</span><a name="line-294"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;imisFromGroupedSequence: The keys are not all the same.&quot;</span><span>
</span><a name="line-295"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-296"></a><span>    </span><a name="local-6989586621679188849"><a href="#local-6989586621679188849"><span class="hs-identifier">headGroup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679188848"><span class="hs-identifier hs-var">group</span></a><span> </span><span class="hs-operator hs-var">S.!?</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-297"></a><span>    </span><a name="local-6989586621679188850"><a href="#local-6989586621679188850"><span class="hs-identifier">keys</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679188848"><span class="hs-identifier hs-var">group</span></a><span>
</span><a name="line-298"></a><span>    </span><a name="local-6989586621679188851"><a href="#local-6989586621679188851"><span class="hs-identifier">headKey</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679188849"><span class="hs-identifier hs-var">headGroup</span></a><span>
</span><a name="line-299"></a><span>    </span><a name="local-6989586621679188852"><a href="#local-6989586621679188852"><span class="hs-identifier">keyCheck</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679188851"><span class="hs-identifier hs-var">headKey</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679188850"><span class="hs-identifier hs-var">keys</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>    </span><a name="local-6989586621679188853"><a href="#local-6989586621679188853"><span class="hs-identifier">values</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IS.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679188848"><span class="hs-identifier hs-var">group</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-comment">{-|
This function implements
[groupBy](http://hackage.haskell.org/package/base-4.12.0.0/docs/Data-List.html#v:groupBy) as in
Data.List:
&quot;The group function takes a list and returns a list of lists such that the concatenation of the
result is equal to the argument. Moreover, each sublist in the result contains only equal elements.&quot;
-}</span><span>
</span><a name="line-309"></a><span class="hs-identifier">groupBy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679187910"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679187910"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><a href="#local-6989586621679187910"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><a href="#local-6989586621679187910"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><a name="groupBy"><a href="Spicy.Molecule.Util.html#groupBy"><span class="hs-identifier">groupBy</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">S.Empty</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-311"></a><span class="hs-identifier">groupBy</span><span> </span><a name="local-6989586621679188855"><a href="#local-6989586621679188855"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679188856"><a href="#local-6989586621679188856"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-operator hs-var">:&lt;|</span><span> </span><a name="local-6989586621679188857"><a href="#local-6989586621679188857"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679188856"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">:&lt;|</span><span> </span><a href="#local-6989586621679188858"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">:&lt;|</span><span> </span><a href="Spicy.Molecule.Util.html#groupBy"><span class="hs-identifier hs-var">groupBy</span></a><span> </span><a href="#local-6989586621679188855"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679188859"><span class="hs-identifier hs-var">zs</span></a><span>
</span><a name="line-312"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679188858"><a href="#local-6989586621679188858"><span class="hs-identifier">ys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679188859"><a href="#local-6989586621679188859"><span class="hs-identifier">zs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.spanl</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679188855"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679188856"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679188857"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-314"></a></pre></body></html>