<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Spicy.MolWriter
Description : Writing chemical data formats
Copyright   : Phillip Seeber, 2019
License     : GPL-3
Maintainer  : phillip.seeber@uni-jena.de
Stability   : experimental
Portability : POSIX, Windows

A module which converts the internal Molecule representation to a string, which is a common chemical
file format, that can be read by Avogadro, VMD, OpenBabel etc.. The writers are not fool proof with
respect to force field types, which should always be remembered when usings its results.
-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Spicy.MolWriter</span><span>
</span><a name="line-16"></a><span class="hs-special">(</span><span> </span><a href="Spicy.MolWriter.html#writeXYZ"><span class="hs-identifier hs-var">writeXYZ</span></a><span>
</span><a name="line-17"></a><span class="hs-special">,</span><span> </span><a href="Spicy.MolWriter.html#writeTXYZ"><span class="hs-identifier hs-var">writeTXYZ</span></a><span>
</span><a name="line-18"></a><span class="hs-special">,</span><span> </span><a href="Spicy.MolWriter.html#writeMOL2"><span class="hs-identifier hs-var">writeMOL2</span></a><span>
</span><a name="line-19"></a><span class="hs-special">,</span><span> </span><a href="Spicy.MolWriter.html#writeSpicy"><span class="hs-identifier hs-var">writeSpicy</span></a><span>
</span><a name="line-20"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Accelerate</span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Accelerate.IO.Data.Vector.Generic</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Accelerate.LLVM.Native</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap.Lazy</span><span>                             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntSet</span><span>                                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">I</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntSet</span><span>                                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List.Split</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Text.Lazy</span><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text.Lazy</span><span>                               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Tuple</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector</span><span>                                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">VB</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector.Storable</span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">VS</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Lens.Micro.Platform</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Types.html"><span class="hs-identifier">Spicy.Types</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Printf</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">{-|
Portable new line character.
-}</span><span>
</span><a name="line-43"></a><span class="hs-identifier">nL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-44"></a><a name="nL"><a href="Spicy.MolWriter.html#nL"><span class="hs-identifier">nL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T.unlines</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">{-|
'T.unlines' like behaviour for 'VB.Vector's of 'Text'. Every single element of the 'VB.Vector' will
have its own line.
-}</span><span>
</span><a name="line-50"></a><span class="hs-identifier">vUnlines</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VB.Vector</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-51"></a><a name="vUnlines"><a href="Spicy.MolWriter.html#vUnlines"><span class="hs-identifier">vUnlines</span></a></a><span> </span><a name="local-6989586621679272794"><a href="#local-6989586621679272794"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VB.foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679272795"><a href="#local-6989586621679272795"><span class="hs-identifier">acc</span></a></a><span> </span><a name="local-6989586621679272796"><a href="#local-6989586621679272796"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679272795"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679272796"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span> </span><a href="Spicy.MolWriter.html#nL"><span class="hs-identifier hs-var">nL</span></a><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621679272794"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">{-|
'T.concat' like behaviour for 'VB.Vector's of 'Text'. No new line characters will be added, but
already existing ones will be used.
-}</span><span>
</span><a name="line-57"></a><span class="hs-identifier">vConcat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VB.Vector</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-58"></a><a name="vConcat"><a href="Spicy.MolWriter.html#vConcat"><span class="hs-identifier">vConcat</span></a></a><span> </span><a name="local-6989586621679272797"><a href="#local-6989586621679272797"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VB.foldl'</span><span> </span><span class="hs-identifier hs-var">T.append</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621679272797"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">{-|
Write a Molden XYZ file from a molecule. This format ignores all deep level layers of a molecule.
-}</span><span>
</span><a name="line-63"></a><span class="hs-identifier">writeXYZ</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-64"></a><a name="writeXYZ"><a href="Spicy.MolWriter.html#writeXYZ"><span class="hs-identifier">writeXYZ</span></a></a><span> </span><a name="local-6989586621679272798"><a href="#local-6989586621679272798"><span class="hs-identifier">mol</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-comment">-- Header section with number of atoms and comment</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-identifier hs-var">T.unlines</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VB.length</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679272798"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679272798"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Label"><span class="hs-identifier hs-var">molecule_Label</span></a><span>
</span><a name="line-69"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-comment">-- Body with element symbols and XYZ coordinates</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-special">(</span><a href="Spicy.MolWriter.html#vUnlines"><span class="hs-identifier hs-var">vUnlines</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VB.map</span><span> </span><a href="#local-6989586621679272799"><span class="hs-identifier hs-var">a2xyz</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679272798"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- Write informations about a single atom to a line</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-identifier">a2xyz</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-76"></a><span>    </span><a name="local-6989586621679272799"><a href="#local-6989586621679272799"><span class="hs-identifier">a2xyz</span></a></a><span> </span><a name="local-6989586621679272800"><a href="#local-6989586621679272800"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-77"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;%-4s&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679272800"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#atom_Element"><span class="hs-identifier hs-var">atom_Element</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-79"></a><span>      </span><span class="hs-special">(</span><a href="Spicy.MolWriter.html#vConcat"><span class="hs-identifier hs-var">vConcat</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VB.map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;    %12.8F&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VS.convert</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679272800"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#atom_Coordinates"><span class="hs-identifier hs-var">atom_Coordinates</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">{-|
Write a Tinker XYZ from a 'Molecule'. The writer trusts the '_atom_FFType' to be
correct (if set) and will simply write them out. Therefore it is possible, that wrong atom types can
be written. If they are not set, the writer will simply equalise all atom types to 0, which is OK
for visualisation but obviously not for MM.

This format ingores all deeper level layers of a molecule.
-}</span><span>
</span><a name="line-89"></a><span class="hs-identifier">writeTXYZ</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-90"></a><a name="writeTXYZ"><a href="Spicy.MolWriter.html#writeTXYZ"><span class="hs-identifier">writeTXYZ</span></a></a><span> </span><a name="local-6989586621679273265"><a href="#local-6989586621679273265"><span class="hs-identifier">mol</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679273275"><a href="#local-6989586621679273275"><span class="hs-identifier">atoms</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679273265"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span>
</span><a name="line-92"></a><span>      </span><a name="local-6989586621679273276"><a href="#local-6989586621679273276"><span class="hs-identifier">nAtoms</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VB.length</span><span> </span><a href="#local-6989586621679273275"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-93"></a><span>      </span><span class="hs-comment">-- Index the atoms. Ignore higher</span><span>
</span><a name="line-94"></a><span>      </span><a name="local-6989586621679273277"><a href="#local-6989586621679273277"><span class="hs-identifier">atomsIndexed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VB.zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VB.generate</span><span> </span><a href="#local-6989586621679273276"><span class="hs-identifier hs-var">nAtoms</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679273278"><a href="#local-6989586621679273278"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679273278"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679273275"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-95"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><span class="hs-comment">-- Header line with number of atoms and comment</span><span>
</span><a name="line-96"></a><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679273276"><span class="hs-identifier hs-var">nAtoms</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;  &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679273265"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Label"><span class="hs-identifier hs-var">molecule_Label</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-98"></a><span>         </span><a href="Spicy.MolWriter.html#nL"><span class="hs-identifier hs-var">nL</span></a><span>
</span><a name="line-99"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-101"></a><span>      </span><span class="hs-comment">-- Body with one atom per line</span><span>
</span><a name="line-102"></a><span>      </span><span class="hs-special">(</span><span> </span><a href="Spicy.MolWriter.html#vUnlines"><span class="hs-identifier hs-var">vUnlines</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VB.map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679273279"><a href="#local-6989586621679273279"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679273280"><a href="#local-6989586621679273280"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-103"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;%-6d  &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679273279"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-105"></a><span>          </span><a href="#local-6989586621679273266"><span class="hs-identifier hs-var">a2txyz</span></a><span> </span><a href="#local-6989586621679273280"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-106"></a><span>          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-107"></a><span>          </span><a href="#local-6989586621679273267"><span class="hs-identifier hs-var">m2txyz</span></a><span> </span><a href="#local-6989586621679273265"><span class="hs-identifier hs-var">mol</span></a><span> </span><a href="#local-6989586621679273279"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-108"></a><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679273277"><span class="hs-identifier hs-var">atomsIndexed</span></a><span>
</span><a name="line-109"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-comment">-- Write element, XYZ coordinates and force field type of an atom.</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-identifier">a2txyz</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-113"></a><span>    </span><a name="local-6989586621679273266"><a href="#local-6989586621679273266"><span class="hs-identifier">a2txyz</span></a></a><span> </span><a name="local-6989586621679273268"><a href="#local-6989586621679273268"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-114"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;%-4s&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679273268"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#atom_Element"><span class="hs-identifier hs-var">atom_Element</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-116"></a><span>      </span><span class="hs-special">(</span><a href="Spicy.MolWriter.html#vConcat"><span class="hs-identifier hs-var">vConcat</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VB.map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;    %12.8F&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VS.convert</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679273268"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#atom_Coordinates"><span class="hs-identifier hs-var">atom_Coordinates</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-118"></a><span>      </span><span class="hs-string">&quot;      &quot;</span><span>
</span><a name="line-119"></a><span>      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span>
</span><a name="line-120"></a><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679273268"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#atom_FFType"><span class="hs-identifier hs-var">atom_FFType</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-121"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;%10s     &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;0&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;%10s     &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679273268"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#atom_FFType"><span class="hs-identifier hs-var">atom_FFType</span></a><span>
</span><a name="line-123"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-comment">-- Write connectivity of an atom (specified by its index). If no bonding informations can be</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-comment">-- found, do not write them.</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-identifier">m2txyz</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-127"></a><span>    </span><a name="local-6989586621679273267"><a href="#local-6989586621679273267"><span class="hs-identifier">m2txyz</span></a></a><span> </span><a name="local-6989586621679273269"><a href="#local-6989586621679273269"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679273270"><a href="#local-6989586621679273270"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-128"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679273271"><a href="#local-6989586621679273271"><span class="hs-identifier">iBonds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679273270"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">IM.lookup</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679273269"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Bonds"><span class="hs-identifier hs-var">molecule_Bonds</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>      </span><span class="hs-keyword">in</span><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679273271"><span class="hs-identifier hs-var">iBonds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-130"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679273272"><a href="#local-6989586621679273272"><span class="hs-identifier">b</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-131"></a><span>              </span><span class="hs-identifier hs-var">IS.foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679273273"><a href="#local-6989586621679273273"><span class="hs-identifier">acc</span></a></a><span> </span><a name="local-6989586621679273274"><a href="#local-6989586621679273274"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679273273"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T.append</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;%6d  &quot;</span><span> </span><a href="#local-6989586621679273274"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS.map</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679273272"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">{-|
Write a simplified .mol2 file (Tripos SYBYL) from a 'Molecule', containing the atoms, connectivities
(single bonds only) and partial charges. The writer is not fool proof and will happily accept any
'_atom_FFType' that is supplied, even if it is not a TRIPOS SYBYL atom type. This can lead to mol2
files that have correct topology and geometry, but visualisation programs wont be able to assign
correct elements.
-}</span><span>
</span><a name="line-141"></a><span class="hs-identifier">writeMOL2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-142"></a><a name="writeMOL2"><a href="Spicy.MolWriter.html#writeMOL2"><span class="hs-identifier">writeMOL2</span></a></a><span> </span><a name="local-6989586621679273281"><a href="#local-6989586621679273281"><span class="hs-identifier">mol</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-143"></a><span class="hs-comment">{-
  let atoms  = mol ^. molecule_Atoms
      nAtoms = VB.length atoms
      bonds  = mol ^. molecule_Bonds
      nBonds = IM.size bonds
  in  -- Header of the MOL2.
      T.unlines
        [ &quot;@&lt;TRIPOS&gt;MOLECULE&quot;
        , T.pack $ mol ^. molecule_Label
        , T.pack $ show nAtoms ++ &quot; &quot; ++ show nBonds ++ &quot; 0 0 0&quot;
        , &quot;SMALL&quot;
        , &quot;GASTEIGER&quot;
        , &quot;&quot;
        ]
      `T.append`
      -- Atoms section containing indices, chemical element, XYZ coordinates, force field type
      &quot;@&lt;TRIPOS&gt;ATOM&quot;
      `T.append`
  where
    a2mol :: Atom -&gt; Text
    a2mol a
-}</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-comment">{-
  &quot;@&lt;TRIPOS&gt;MOLECULE&quot; ++ &quot;\n&quot; ++
  mol ^. molecule_Label ++ &quot;\n&quot; ++
  show nAtoms ++ &quot; &quot; ++ show nBonds ++ &quot; 0 0 0&quot; ++ &quot;\n&quot; ++
  &quot;SMALL&quot; ++ &quot;\n&quot; ++
  &quot;GASTEIGER&quot; ++ &quot;\n\n&quot; ++

  &quot;@&lt;TRIPOS&gt;ATOM&quot; ++ &quot;\n&quot; ++
  concat
    ( map (\(n, a) -&gt;
        printf &quot;%6d    &quot;        n ++
        printf &quot;%-4s    &quot;       (show $ a ^. atom_Element) ++
        (\(x, y, z) -&gt; printf &quot;%12.8F    %12.8F    %12.8F        &quot; x y z)
          (indexAtomCoordinates $ a ^. atom_Coordinates) ++
        printf &quot;%-8s    &quot;
          (if a ^. atom_FFType == &quot;&quot;
             then show (a ^. atom_Element) ++
                  &quot;.&quot; ++
                  show (length . I.toList $ a ^. atom_Connectivity)
             else a ^. atom_FFType
          ) ++
        printf &quot;%2d    &quot; (1 :: Int) ++
        printf &quot;%4s    &quot; &quot;UNL1&quot; ++
        printf &quot;%12.8F\n&quot; (fromMaybe 0.0 $ a ^. atom_PCharge)
      ) numberedAtoms
    ) ++ &quot;\n&quot; ++
    &quot;@&lt;TRIPOS&gt;BOND&quot; ++ &quot;\n&quot; ++
    concat
      ( map (\(n, (o, t)) -&gt; printf &quot;    %6d    &quot; n ++
                           printf &quot;%6d    &quot; o ++
                           printf &quot;%6d    &quot; t ++
                           printf &quot;%6d\n&quot; (1 :: Int)
            ) numberedBonds
      )
  where
    atoms = mol ^. molecule_Atoms
    nAtoms = V.length atoms
    numberedAtoms = V.generate nAtoms (\i -&gt; (i, atoms V.! i))
    bonds = map (I.toList . (^. atom_Connectivity)) $ V.toList atoms
    pairBondsRedundant =
      concat
      [ map (\a -&gt; (i + 1, a + 1)) (bonds !! i)
      | i &lt;- [ 0 .. length bonds - 1 ]
      ]
    pairBonds =
      foldr (\a acc -&gt; if swap a `elem` acc
                       then delete a acc
                       else acc
            ) pairBondsRedundant pairBondsRedundant
    nBonds = length pairBonds
    bondIndexList = [ 1 .. nBonds]
    numberedBonds = V.generate nBonds (\i -&gt; (i, pairBonds !! i))
-}</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-comment">{-|
Write Spicy format, which is a custom format (not stable yet), containing all informations, that are
internally used to represent a molecule.
-}</span><span>
</span><a name="line-225"></a><span class="hs-identifier">writeSpicy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-226"></a><a name="writeSpicy"><a href="Spicy.MolWriter.html#writeSpicy"><span class="hs-identifier">writeSpicy</span></a></a><span> </span><a name="local-6989586621679273282"><a href="#local-6989586621679273282"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-227"></a><span class="hs-comment">{-
  &quot;#Spicy-Format v0.2\n&quot; ++
  &quot;\n&quot; ++
  &quot;#Spicy-Molecule\n&quot; ++
  &quot;  Label:\n&quot; ++
  &quot;    &quot; ++ (m ^. molecule_Label) ++ &quot;\n&quot; ++
  case energy of
    Nothing -&gt; &quot;&quot;
    Just e -&gt;
      &quot;  Energy / Hartree:\n&quot; ++
      &quot;    &quot; ++ printf &quot;%20.10e\n&quot; e
  ++
  case gradient of
    Nothing -&gt; &quot;&quot;
    Just g -&gt;
      &quot;  Gradient / Hartee/Bohr:\n&quot; ++
      (concat . map (&quot;  &quot; ++) . map writeSafeListToLine . chunksOf 3 . V.toList $ g)
      --( concat . map ((++ &quot;\n&quot;) . (&quot;    &quot; ++) . show) . chunksOf 3 . toList $ g )
  ++
  case hessian of
    Nothing -&gt; &quot;&quot;
    Just h -&gt;
      &quot;  Hessian / a.u.:\n&quot; ++
      ( concat . map ((++ &quot;\n&quot;) . (&quot;    &quot; ++)) . splitOn &quot;\n&quot; . show $ h )
  ++
  &quot;\n&quot; ++
  &quot;#Spicy-Atoms\n&quot; ++
  ( concat . map
      ( \a -&gt;
          printf &quot;  %3s  &quot; (show $ a ^. atom_Element) ++
          printf &quot;  %6s  &quot; (a ^. atom_Label) ++
          printf &quot;  %1s  &quot; (if (a ^. atom_IsPseudo) then &quot;P&quot; else &quot;&quot;) ++
          printf &quot;  %6s  &quot; (a ^. atom_FFType) ++
          printf &quot;  %8s  &quot;
            ( case (a ^. atom_PCharge) of
                Nothing -&gt; &quot;No&quot;
                Just c  -&gt; printf &quot;%8.5f&quot; c
            ) ++
          (\(x, y, z) -&gt; printf &quot;  %16.10f  %16.10f  %16.10f  &quot; x y z)
            (indexAtomCoordinates $ a ^. atom_Coordinates) ++
          (concat . map (printf &quot;  %6d  &quot;) . I.toList $ a ^. atom_Connectivity) ++
          &quot;\n&quot;
      ) $ V.toList atoms
    )
  where
    atoms = m ^. molecule_Atoms
    energy = m ^. molecule_Energy
    gradient = m ^. molecule_Gradient
    hessian = m ^. molecule_Hessian
    writeSafeListToLine :: (Floating a, PrintfArg a) =&gt; [a] -&gt; String
    writeSafeListToLine [] = &quot;&quot;
    writeSafeListToLine [x] = printf &quot;  %8.5f\n&quot; x
    writeSafeListToLine (x:xs) =
      printf &quot;  %8.5f  &quot; x ++
      writeSafeListToLine xs
-}</span><span>
</span><a name="line-283"></a></pre></body></html>