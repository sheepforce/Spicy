<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Spicy.Math
Description : Basic mathematical operations
Copyright   : Phillip Seeber, 2019
License     : GPL-3
Maintainer  : phillip.seeber@uni-jena.de
Stability   : experimental
Portability : POSIX, Windows

This module defines basic algebraic operations used throughout the program. Numerical heavy and most
other operations are implemented using Accelerate, to provide parallel operations. Note that all
'A.runQ' provided functions must be typed without typeclasses but by concrete types.
-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Spicy.Math</span><span>
</span><a name="line-16"></a><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="Spicy.Math.html#%2229"><span class="hs-operator hs-var">&#8745;</span></a><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Spicy.Math.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Accelerate</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Accelerate.LLVM.Native</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Accelerate.Numeric.LinearAlgebra</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Math.Helper.html"><span class="hs-identifier">Spicy.Math.Helper</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">{-
(&lt;!!&gt;) :: (A.Shape sh, A.Elt e) =&gt; A.Array sh e -&gt; Int -&gt; e
arr &lt;!!&gt; ix =
  let accAtIx = A.runQ $ A.unit $ arr A.!! ix :: A.Scalar e
      atIx = head . A.toList $ accAtIx
  in  atIx
  -}</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">{-|
Intersection (subset) of two lists a and b.
-}</span><span>
</span><a name="line-38"></a><span class="hs-special">(</span><span class="hs-operator">&#8745;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679144130"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679144130"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679144130"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679144130"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-39"></a><a name="local-6989586621679147969"><a href="#local-6989586621679147969"><span class="hs-identifier">a</span></a></a><span> </span><a name="%2229"><a href="Spicy.Math.html#%2229"><span class="hs-operator">&#8745;</span></a></a><span> </span><a name="local-6989586621679147970"><a href="#local-6989586621679147970"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679147969"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersect</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679147970"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">{-|
Dot product of two 'A.Vector's.
-}</span><span>
</span><a name="line-44"></a><span class="hs-special">(</span><span class="hs-operator">&lt;.&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-45"></a><a name="local-6989586621679148127"><a href="#local-6989586621679148127"><span class="hs-identifier">a</span></a></a><span> </span><a name="%3C.%3E"><a href="Spicy.Math.html#%3C.%3E"><span class="hs-operator">&lt;.&gt;</span></a></a><span> </span><a name="local-6989586621679148128"><a href="#local-6989586621679148128"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.toList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679148129"><span class="hs-identifier hs-var">vvP'</span></a><span> </span><a href="#local-6989586621679148127"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679148128"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-47"></a><span>    </span><a name="local-6989586621679148129"><a href="#local-6989586621679148129"><span class="hs-identifier">vvP'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><span> </span><span class="hs-identifier hs-var">A.runQ</span><span> </span><span class="hs-identifier hs-var">vvP</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">{-|
'A.Matrix' 'A.Vector' product.
-}</span><span>
</span><a name="line-52"></a><span class="hs-special">(</span><span class="hs-operator">#&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">A.Matrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-53"></a><a name="local-6989586621679158881"><a href="#local-6989586621679158881"><span class="hs-identifier">m</span></a></a><span> </span><a name="%23%3E"><a href="Spicy.Math.html#%23%3E"><span class="hs-operator">#&gt;</span></a></a><span> </span><a name="local-6989586621679158882"><a href="#local-6989586621679158882"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679158883"><span class="hs-identifier hs-var">mvP'</span></a><span> </span><a href="#local-6989586621679158881"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679158882"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-55"></a><span>    </span><a name="local-6989586621679158883"><a href="#local-6989586621679158883"><span class="hs-identifier">mvP'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><span> </span><span class="hs-identifier hs-var">A.runQ</span><span> </span><span class="hs-identifier hs-var">mvP</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">{-|
'A.Vector' 'A.Matrix' product.
-}</span><span>
</span><a name="line-60"></a><span class="hs-special">(</span><span class="hs-operator">&lt;#</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Matrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-61"></a><a name="local-6989586621679158911"><a href="#local-6989586621679158911"><span class="hs-identifier">v</span></a></a><span> </span><a name="%3C%23"><a href="Spicy.Math.html#%3C%23"><span class="hs-operator">&lt;#</span></a></a><span> </span><a name="local-6989586621679158912"><a href="#local-6989586621679158912"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679158913"><span class="hs-identifier hs-var">vmP'</span></a><span> </span><a href="#local-6989586621679158911"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679158912"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-63"></a><span>    </span><a name="local-6989586621679158913"><a href="#local-6989586621679158913"><span class="hs-identifier">vmP'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><span> </span><span class="hs-identifier hs-var">A.runQ</span><span> </span><span class="hs-identifier hs-var">vmP</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">{-|
'A.Matrix' 'A.Matrix' product.
-}</span><span>
</span><a name="line-68"></a><span class="hs-special">(</span><span class="hs-operator">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">A.Matrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Matrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Matrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-69"></a><a name="local-6989586621679158941"><a href="#local-6989586621679158941"><span class="hs-identifier">a</span></a></a><span> </span><a name="%3C%3E"><a href="Spicy.Math.html#%3C%3E"><span class="hs-operator">&lt;&gt;</span></a></a><span> </span><a name="local-6989586621679158942"><a href="#local-6989586621679158942"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679158943"><span class="hs-identifier hs-var">mmP'</span></a><span> </span><a href="#local-6989586621679158941"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679158942"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-70"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-71"></a><span>    </span><a name="local-6989586621679158943"><a href="#local-6989586621679158943"><span class="hs-identifier">mmP'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><span> </span><span class="hs-identifier hs-var">A.runQ</span><span> </span><span class="hs-identifier hs-var">mmP</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">{-
{-|
Length of a 'A.Vector'.
-}
vLength :: (A.Numeric a, Floating a) =&gt; A.Vector a -&gt; a
vLength a = sqrt (a &lt;.&gt; a)

{-|
Distance between 2 points ('A.Vector's).
-}
-- For Accelerate's fusion, don't call 'vLength' here.
vDistance :: (A.Numeric a, Floating a) =&gt; A.Vector a -&gt; A.Vector a -&gt; a
vDistance a b = sqrt . head . A.toList $ (A.runN f) a b
  where
    f :: (A.Numeric a, Floating a) =&gt; A.Acc (A.Vector a) -&gt; A.Acc (A.Vector a) -&gt; A.Acc (A.Scalar a)
    f v1 v2 = (\x -&gt; x A.&lt;.&gt; x) $ A.zipWith (-) v1 v2


{-|
Angle between to 'A.Vector's in radian.
-}
-- For Accelerate's fusion, don't call other 'Spicy.Math' functions here.
vAngle :: A.Vector Double -&gt; A.Vector Double -&gt; Double
vAngle a b = head . A.toList $ (A.runN f) a b
  where
    f :: A.Acc (A.Vector Double) -&gt; A.Acc (A.Vector Double) -&gt; A.Acc (A.Scalar Double)
    f x y = A.zipWith (/) (dividend x y) (divisor x y)-- (\x -&gt; x A.&lt;.&gt; x) $ A.zipWith (-) v1 v2
    --
    dividend :: A.Acc (A.Vector Double) -&gt; A.Acc (A.Vector Double) -&gt; A.Acc (A.Scalar Double)
    dividend x y = x A.&lt;.&gt; y
    --
    divisor :: A.Acc (A.Vector Double) -&gt; A.Acc (A.Vector Double) -&gt; A.Acc (A.Scalar Double)
    divisor x y = A.zipWith (*) (vLength' x) (vLength' y)
    --
    vLength' :: A.Acc (A.Vector Double) -&gt; A.Acc (A.Scalar Double)
    vLength' x = A.map A.sqrt $ (x A.&lt;.&gt; x)


{-
-- | Defines the normal vector of a plane, defined by 3 points
r3VecNormalVecOfPlane3Points :: (Vector R, Vector R, Vector R) -&gt; Vector R
r3VecNormalVecOfPlane3Points (a, b, c) = (b - a) `cross` (c - a)

-- | Dihedral angle between 4 atoms
r3VecDihedral :: (Vector R, Vector R, Vector R, Vector R) -&gt; R
r3VecDihedral (a, b, c, d) = hmVecAngle (p1Normal, p2Normal)
  where
    p1Normal = r3VecNormalVecOfPlane3Points (a, b, c)
    p2Normal = r3VecNormalVecOfPlane3Points (b, c, d)
-}

-- vectorProduct :: A.Vector Double -&gt; A.Vector Double -&gt; A.Scalar Double
-- vectorProduct = $( A.runQ vectorProduct' )
-}</span><span>
</span><a name="line-127"></a></pre></body></html>