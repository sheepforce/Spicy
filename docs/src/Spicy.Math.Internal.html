<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Spicy.Math.Helper
Description : Basic mathematical operations, auxiliary functions for runQ
Copyright   : Phillip Seeber, 2019
License     : GPL-3
Maintainer  : phillip.seeber@uni-jena.de
Stability   : experimental
Portability : POSIX, Windows

Definitions of auxiliary functions to deal with the GHC bug, making it necessary to have all
'A.runQ' expressions as untyped slices. Functions in this module are not meant for direct use, but
wrapped in the 'Spicy.Math' module.
-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Spicy.Math.Internal</span><span>
</span><a name="line-16"></a><span class="hs-special">(</span><span> </span><a href="Spicy.Math.Internal.html#getCoordinates"><span class="hs-identifier hs-var">getCoordinates</span></a><span>
</span><a name="line-17"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Math.Internal.html#distMat"><span class="hs-identifier hs-var">distMat</span></a><span>
</span><a name="line-18"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Parallel.Strategies</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Array.Accelerate</span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Array.Accelerate.Control.Lens</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Array.Accelerate.IO.Data.Vector.Storable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">AVS</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Foldable</span><span>                                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">F</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span>                                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Sequence</span><span>                                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector.Storable</span><span>                          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">VS</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>                                       </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cycle</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>                                                                </span><span class="hs-identifier hs-var">foldl1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>                                                                </span><span class="hs-identifier hs-var">head</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">init</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>                                                                </span><span class="hs-identifier hs-var">last</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">maximum</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>                                                                </span><span class="hs-identifier hs-var">minimum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tail</span><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>                                                                </span><span class="hs-identifier hs-var">take</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>                                                                </span><span class="hs-special">(</span><span class="hs-operator hs-var">!!</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Types.html"><span class="hs-identifier">Spicy.Types</span></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">{-|
Get the 'Atom' '_atom_Coordinates' from a 'Molecule' and convert to a plain 'VS.Vector'. This is
therefore basically a concatenation of all cartesian coordinates.
-}</span><span>
</span><a name="line-40"></a><span class="hs-identifier">getCoordinates</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Spicy.Types.html#Strat"><span class="hs-identifier hs-type">Strat</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-41"></a><a name="getCoordinates"><a href="Spicy.Math.Internal.html#getCoordinates"><span class="hs-identifier">getCoordinates</span></a></a><span> </span><a name="local-6989586621679500174"><a href="#local-6989586621679500174"><span class="hs-identifier">strat</span></a></a><span> </span><a name="local-6989586621679500175"><a href="#local-6989586621679500175"><span class="hs-identifier">mol</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679500176"><a href="#local-6989586621679500176"><span class="hs-identifier">atomCoords</span></a></a><span>  </span><span class="hs-glyph">=</span><span>
</span><a name="line-43"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679500174"><span class="hs-identifier hs-var">strat</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-44"></a><span>          </span><a href="Spicy.Types.html#Serial"><span class="hs-identifier hs-var">Serial</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-45"></a><span>            </span><span class="hs-identifier hs-var">IM.map</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679500175"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>          </span><a href="Spicy.Types.html#Parallel"><span class="hs-identifier hs-var">Parallel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-47"></a><span>            </span><span class="hs-identifier hs-var">IM.map</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679500175"><span class="hs-identifier hs-var">mol</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Spicy.Types.html#molecule_Atoms"><span class="hs-identifier hs-var">molecule_Atoms</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">using</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">parTraversable</span><span> </span><span class="hs-identifier hs-var">rdeepseq</span><span>
</span><a name="line-48"></a><span>      </span><a name="local-6989586621679500177"><a href="#local-6989586621679500177"><span class="hs-identifier">plainCoords</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">S.&gt;&lt;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span> </span><a href="#local-6989586621679500176"><span class="hs-identifier hs-var">atomCoords</span></a><span>
</span><a name="line-49"></a><span>      </span><a name="local-6989586621679500178"><a href="#local-6989586621679500178"><span class="hs-identifier">plainVec</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VS.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">F.toList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679500177"><span class="hs-identifier hs-var">plainCoords</span></a><span>
</span><a name="line-50"></a><span>      </span><a name="local-6989586621679500179"><a href="#local-6989586621679500179"><span class="hs-identifier">vecLength</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VS.length</span><span> </span><a href="#local-6989586621679500178"><span class="hs-identifier hs-var">plainVec</span></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">AVS.fromVectors</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.Z</span><span> </span><span class="hs-operator hs-var">A.:.</span><span> </span><a href="#local-6989586621679500179"><span class="hs-identifier hs-var">vecLength</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679500178"><span class="hs-identifier hs-var">plainVec</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">{-|
Calculate the distance matrix from the plain cartesian coordinate vector in \(R^(3 N)\) with \(N\)
being the number of atoms. This functions cannot check, if the cartesian input vector has actually 3
N elements and will crash if the number of elements is not divisable by 3. The calling routine needs
to check this. The resulting matrix will be the square distance matrix.
-}</span><span>
</span><a name="line-59"></a><span class="hs-identifier">distMat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">A.Acc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">A.Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Acc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Matrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><a name="distMat"><a href="Spicy.Math.Internal.html#distMat"><span class="hs-identifier">distMat</span></a></a><span> </span><a name="local-6989586621679500214"><a href="#local-6989586621679500214"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Z</span><span> </span><span class="hs-operator hs-var">:.</span><span> </span><a name="local-6989586621679500215"><a href="#local-6989586621679500215"><span class="hs-identifier">n3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unlift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">shape</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679500214"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Z</span><span> </span><span class="hs-operator hs-type">:.</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-62"></a><span>        </span><a name="local-6989586621679500216"><a href="#local-6989586621679500216"><span class="hs-identifier">n</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679500215"><span class="hs-identifier hs-var">n3</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-63"></a><span>        </span><a name="local-6989586621679500217"><a href="#local-6989586621679500217"><span class="hs-identifier">dim</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-64"></a><span>        </span><span class="hs-comment">-- Reshape the 3N cartesion input vector to a 3xN matrix with the number of atoms N on</span><span>
</span><a name="line-65"></a><span>        </span><span class="hs-comment">-- x-axis and (x_n, y_n, z_n) on the y-axis.</span><span>
</span><a name="line-66"></a><span>        </span><a name="local-6989586621679500218"><a href="#local-6989586621679500218"><span class="hs-identifier">n3Vec</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reshape</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">A.Z</span><span> </span><span class="hs-operator hs-var">:.</span><span> </span><a href="#local-6989586621679500216"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">:.</span><span> </span><a href="#local-6989586621679500217"><span class="hs-identifier hs-var">dim</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679500214"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-67"></a><span>        </span><span class="hs-comment">-- The x-Axis is now a repetition of the atoms on the y-Axis (which were previously</span><span>
</span><a name="line-68"></a><span>        </span><span class="hs-comment">-- the x-axis) and z now stores the 3 compotents of the coordinates.</span><span>
</span><a name="line-69"></a><span>        </span><a name="local-6989586621679500219"><a href="#local-6989586621679500219"><span class="hs-identifier">xVec</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">A.replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Z</span><span> </span><span class="hs-operator hs-var">:.</span><span> </span><a href="#local-6989586621679500216"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">:.</span><span> </span><span class="hs-identifier hs-var">All</span><span> </span><span class="hs-operator hs-var">:.</span><span> </span><span class="hs-identifier hs-var">All</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679500218"><span class="hs-identifier hs-var">n3Vec</span></a><span>
</span><a name="line-70"></a><span>        </span><span class="hs-comment">-- Transpose the 3D array to swap x- and y-axis and also have the numbers of the atoms on x</span><span>
</span><a name="line-71"></a><span>        </span><span class="hs-comment">-- again. Strangely the lenses start counting in reverse index order.</span><span>
</span><a name="line-72"></a><span>        </span><a name="local-6989586621679500220"><a href="#local-6989586621679500220"><span class="hs-identifier">yVec</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">transposeOn</span><span> </span><span class="hs-identifier hs-var">_2</span><span> </span><span class="hs-identifier hs-var">_3</span><span> </span><a href="#local-6989586621679500219"><span class="hs-identifier hs-var">xVec</span></a><span>
</span><a name="line-73"></a><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-comment">-- Overlay the two 3D arrays. The x-y-plane is a table correlating all atom indices with</span><span>
</span><a name="line-74"></a><span>        </span><span class="hs-comment">-- each other. The z-axis stores the 3 components of the cartesian coordiantes.</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-comment">-- Now the 3D arrays will elementwise be subtracted from each other, all results squared,</span><span>
</span><a name="line-76"></a><span>        </span><span class="hs-comment">-- the z-components folded and square root will be taken and the distance results.</span><span>
</span><a name="line-77"></a><span>        </span><span class="hs-identifier hs-var">A.map</span><span> </span><span class="hs-identifier hs-var">sqrt</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.sum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.map</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">**</span><span> </span><span class="hs-number">2.0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">A.zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679500219"><span class="hs-identifier hs-var">xVec</span></a><span> </span><a href="#local-6989586621679500220"><span class="hs-identifier hs-var">yVec</span></a><span>
</span><a name="line-78"></a></pre></body></html>