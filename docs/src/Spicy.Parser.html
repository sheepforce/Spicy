<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : Spicy.Parser
Description : Parsers for chemical data formats and computational chemistry output files.
Copyright   : Phillip Seeber, 2019
License     : GPL-3
Maintainer  : phillip.seeber@uni-jena.de
Stability   : experimental
Portability : POSIX, Windows

This module provides parsers for chemical file formats. For the internal representation no parser is
provided, as this is a JSON structured file, which should be parsed by
[aeson](http://hackage.haskell.org/package/aeson)'s @decodeEither@.
-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Spicy.Parser</span><span>
</span><a name="line-16"></a><span class="hs-special">(</span><span> </span><span class="hs-comment">-- * Chemical Data Formats</span><span>
</span><a name="line-17"></a><span>  </span><a href="Spicy.Parser.html#parseXYZ"><span class="hs-identifier hs-var">parseXYZ</span></a><span>
</span><a name="line-18"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parseTXYZ"><span class="hs-identifier hs-var">parseTXYZ</span></a><span>
</span><a name="line-19"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parseMOL2"><span class="hs-identifier hs-var">parseMOL2</span></a><span>
</span><a name="line-20"></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#parsePDB"><span class="hs-identifier hs-var">parsePDB</span></a><span>
</span><a name="line-21"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Attoparsec.Text.Lazy</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Char</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Either</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IntMap</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IntSet</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntSet</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Sequence</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Sequence</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TS</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text.Lazy</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TL</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text.Lazy.Read</span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TL</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Tuple</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Lens.Micro.Platform</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>                   </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cycle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">head</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                            </span><span class="hs-identifier hs-var">init</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">last</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">maximum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">minimum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tail</span><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                            </span><span class="hs-identifier hs-var">take</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">!!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Molecule.Util.html"><span class="hs-identifier">Spicy.Molecule.Util</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><a href="Spicy.Types.html"><span class="hs-identifier">Spicy.Types</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Read</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- import Data.Monoid</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- import Data.Sequence (Seq)</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- import Debug.Trace</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- import Control.DeepSeq</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">{-|
Make a parser optional and wrap it in a 'Maybe'.
-}</span><span>
</span><a name="line-54"></a><span class="hs-identifier">maybeOption</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="#local-6989586621679475015"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679475015"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><a name="maybeOption"><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier">maybeOption</span></a></a><span> </span><a name="local-6989586621679475016"><a href="#local-6989586621679475016"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">option</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679475016"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">{-|
Parser for skiping non line breaking space.
-}</span><span>
</span><a name="line-60"></a><span class="hs-identifier">skipSpace'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><a name="skipSpace%27"><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier">skipSpace'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-char">' '</span><span class="hs-special">,</span><span> </span><span class="hs-char">'\t'</span><span class="hs-special">,</span><span> </span><span class="hs-char">'\f'</span><span class="hs-special">,</span><span> </span><span class="hs-char">'\v'</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">{-|
Convert strict text to lazy text.
-}</span><span>
</span><a name="line-68"></a><span class="hs-identifier">textS2L</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TS.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TL.Text</span><span>
</span><a name="line-69"></a><a name="textS2L"><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier">textS2L</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TS.unpack</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-comment">----------------------------------------------------------------------------------------------------</span><span>
</span><a name="line-72"></a><span class="hs-comment">{-|
Parse a .xyz file (has no connectivity, atom types or partioal charges).
-}</span><span>
</span><a name="line-75"></a><span class="hs-identifier">parseXYZ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-76"></a><a name="parseXYZ"><a href="Spicy.Parser.html#parseXYZ"><span class="hs-identifier">parseXYZ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-77"></a><span>  </span><a name="local-6989586621679475504"><a href="#local-6989586621679475504"><span class="hs-identifier">nAtoms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-keyword">label</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isEndOfLine</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-79"></a><span>  </span><a name="local-6989586621679475506"><a href="#local-6989586621679475506"><span class="hs-identifier">atoms</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="#local-6989586621679475504"><span class="hs-identifier hs-var">nAtoms</span></a><span> </span><a href="#local-6989586621679475213"><span class="hs-identifier hs-var">xyzLineParser</span></a><span>
</span><a name="line-80"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679475506"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-83"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-85"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-88"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-identifier">xyzLineParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span>
</span><a name="line-91"></a><span>    </span><a name="local-6989586621679475213"><a href="#local-6989586621679475213"><span class="hs-identifier">xyzLineParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-92"></a><span>      </span><a name="local-6989586621679475500"><a href="#local-6989586621679475500"><span class="hs-identifier">cElement</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span>
</span><a name="line-93"></a><span>      </span><a name="local-6989586621679475501"><a href="#local-6989586621679475501"><span class="hs-identifier">x</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-94"></a><span>      </span><a name="local-6989586621679475502"><a href="#local-6989586621679475502"><span class="hs-identifier">y</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-95"></a><span>      </span><a name="local-6989586621679475503"><a href="#local-6989586621679475503"><span class="hs-identifier">z</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-96"></a><span>      </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-97"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-var">Atom</span></a><span>
</span><a name="line-98"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_atom_Element</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Spicy.Types.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679475500"><span class="hs-identifier hs-var">cElement</span></a><span>
</span><a name="line-99"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Label</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_IsPseudo</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_FFType</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_PCharge</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-103"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679475501"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475502"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475503"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span>
</span><a name="line-104"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">{-|
Parse a Tinker XYZ formatted file. It has coordinates and might have connectivity and atom types.
This format and therefore parser are not using any layers (recursions of 'Molecule').
-}</span><span>
</span><a name="line-110"></a><span class="hs-identifier">parseTXYZ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-111"></a><a name="parseTXYZ"><a href="Spicy.Parser.html#parseTXYZ"><span class="hs-identifier">parseTXYZ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>  </span><a name="local-6989586621679475689"><a href="#local-6989586621679475689"><span class="hs-identifier">_nAtoms</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-keyword">label</span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isEndOfLine</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-114"></a><span>  </span><a name="local-6989586621679475691"><a href="#local-6989586621679475691"><span class="hs-identifier">conAndAtoms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><a href="#local-6989586621679475679"><span class="hs-identifier hs-var">txyzLineParser</span></a><span>
</span><a name="line-115"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679475692"><a href="#local-6989586621679475692"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679475692"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_1</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475692"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_2</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679475691"><span class="hs-identifier hs-var">conAndAtoms</span></a><span>
</span><a name="line-118"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679475691"><span class="hs-identifier hs-var">conAndAtoms</span></a><span>
</span><a name="line-119"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-121"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-123"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-124"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-comment">-- Parsing a single line of atoms. Tinker's format keeps bonds associated with atoms. So a tuple</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-comment">-- suitable to construct the 'IntMap' is returned additional to the pure atoms.</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-identifier">txyzLineParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>    </span><a name="local-6989586621679475679"><a href="#local-6989586621679475679"><span class="hs-identifier">txyzLineParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-129"></a><span>      </span><a name="local-6989586621679475681"><a href="#local-6989586621679475681"><span class="hs-identifier">index</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-130"></a><span>      </span><a name="local-6989586621679475682"><a href="#local-6989586621679475682"><span class="hs-identifier">cElement</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span>
</span><a name="line-131"></a><span>      </span><a name="local-6989586621679475683"><a href="#local-6989586621679475683"><span class="hs-identifier">x</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-132"></a><span>      </span><a name="local-6989586621679475684"><a href="#local-6989586621679475684"><span class="hs-identifier">y</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-133"></a><span>      </span><a name="local-6989586621679475685"><a href="#local-6989586621679475685"><span class="hs-identifier">z</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-134"></a><span>      </span><a name="local-6989586621679475686"><a href="#local-6989586621679475686"><span class="hs-identifier">mFFType</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-135"></a><span>      </span><a name="local-6989586621679475687"><a href="#local-6989586621679475687"><span class="hs-identifier">connectivityRaw</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many'</span><span> </span><a href="#local-6989586621679475680"><span class="hs-identifier hs-var">columnDecimal</span></a><span>
</span><a name="line-136"></a><span>      </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-137"></a><span>      </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-138"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679475681"><span class="hs-identifier hs-var">index</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IS.fromList</span><span> </span><a href="#local-6989586621679475687"><span class="hs-identifier hs-var">connectivityRaw</span></a><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-var">Atom</span></a><span>
</span><a name="line-140"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_atom_Element</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Spicy.Types.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679475682"><span class="hs-identifier hs-var">cElement</span></a><span>
</span><a name="line-141"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Label</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-142"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_IsPseudo</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-143"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_FFType</span><span>       </span><span class="hs-glyph">=</span><span>
</span><a name="line-144"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679475686"><span class="hs-identifier hs-var">mFFType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-145"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-146"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679475688"><a href="#local-6989586621679475688"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679475688"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_PCharge</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-148"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679475683"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475684"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475685"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span>
</span><a name="line-149"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-150"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-comment">-- Parse multiple non-line-breaking whitespace separated decimals.</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-identifier">columnDecimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-153"></a><span>    </span><a name="local-6989586621679475680"><a href="#local-6989586621679475680"><span class="hs-identifier">columnDecimal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-comment">{-|
Parse the &quot;interesting&quot; fields of a MOL2 file. This contains partial charges as well as
connectivity. There is no special understanding for the atom types, that are available in MOL2
files. They will simply be treated as the force field string. See
&lt;http://chemyang.ccnu.edu.cn/ccb/server/AIMMS/mol2.pdf&gt;.
-}</span><span>
</span><a name="line-161"></a><span class="hs-identifier">parseMOL2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-162"></a><a name="parseMOL2"><a href="Spicy.Parser.html#parseMOL2"><span class="hs-identifier">parseMOL2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-special">(</span><span class="hs-keyword">label</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679476044"><a href="#local-6989586621679476044"><span class="hs-identifier">nAtoms</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476045"><a href="#local-6989586621679476045"><span class="hs-identifier">nBonds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679475693"><span class="hs-identifier hs-var">moleculeParser</span></a><span>
</span><a name="line-164"></a><span>  </span><a name="local-6989586621679476046"><a href="#local-6989586621679476046"><span class="hs-identifier">atomsLabeled</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679475694"><span class="hs-identifier hs-var">atomParser</span></a><span> </span><a href="#local-6989586621679476044"><span class="hs-identifier hs-var">nAtoms</span></a><span>
</span><a name="line-165"></a><span>  </span><a name="local-6989586621679476047"><a href="#local-6989586621679476047"><span class="hs-identifier">bonds</span></a></a><span>                   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679475695"><span class="hs-identifier hs-var">bondParser</span></a><span> </span><a href="#local-6989586621679476045"><span class="hs-identifier hs-var">nBonds</span></a><span>
</span><a name="line-166"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Construct the top layer of the molecule.</span><span>
</span><a name="line-167"></a><span>      </span><a name="local-6989586621679476048"><a href="#local-6989586621679476048"><span class="hs-identifier">atoms</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679476050"><a href="#local-6989586621679476050"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679476051"><a href="#local-6989586621679476051"><span class="hs-identifier">atom</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476050"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476051"><span class="hs-identifier hs-var">atom</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476046"><span class="hs-identifier hs-var">atomsLabeled</span></a><span>
</span><a name="line-168"></a><span>      </span><span class="hs-comment">-- From the groups of same substructure ID fragments, build molecules.</span><span>
</span><a name="line-169"></a><span>      </span><a name="local-6989586621679476049"><a href="#local-6989586621679476049"><span class="hs-identifier">subMols</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Molecule.Util.html#makeSubMolsFromAnnoAtoms"><span class="hs-identifier hs-var">makeSubMolsFromAnnoAtoms</span></a><span> </span><a href="#local-6989586621679476046"><span class="hs-identifier hs-var">atomsLabeled</span></a><span> </span><a href="#local-6989586621679476047"><span class="hs-identifier hs-var">bonds</span></a><span>
</span><a name="line-170"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679476048"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679476047"><span class="hs-identifier hs-var">bonds</span></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679476049"><span class="hs-identifier hs-var">subMols</span></a><span>
</span><a name="line-175"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-179"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-comment">-- Parse the @&lt;TRIPOS&gt;MOLECULE block of MOL2.</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-identifier">moleculeParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TL.Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>    </span><a name="local-6989586621679475693"><a href="#local-6989586621679475693"><span class="hs-identifier">moleculeParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-183"></a><span>      </span><a name="local-6989586621679475696"><a href="#local-6989586621679475696"><span class="hs-identifier">_header</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;@&lt;TRIPOS&gt;MOLECULE&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-184"></a><span>      </span><span class="hs-comment">-- Line 1 -&gt; &quot;mol_name&quot;</span><span>
</span><a name="line-185"></a><span>      </span><span class="hs-keyword">label</span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isEndOfLine</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-186"></a><span>      </span><span class="hs-comment">-- Line 2 -&gt; &quot;num_atoms [num_bonds [num_subst [num_feat [num_sets]]]]&quot;</span><span>
</span><a name="line-187"></a><span>      </span><a name="local-6989586621679475698"><a href="#local-6989586621679475698"><span class="hs-identifier">nAtoms</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-188"></a><span>      </span><a name="local-6989586621679475699"><a href="#local-6989586621679475699"><span class="hs-identifier">nBonds</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-189"></a><span>      </span><a name="local-6989586621679475700"><a href="#local-6989586621679475700"><span class="hs-identifier">_nSubMols</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>      </span><a name="local-6989586621679475701"><a href="#local-6989586621679475701"><span class="hs-identifier">_nFeatures</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>      </span><a name="local-6989586621679475702"><a href="#local-6989586621679475702"><span class="hs-identifier">_nSets</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-192"></a><span>      </span><span class="hs-comment">-- Line 3 -&gt; &quot;mol_type&quot;</span><span>
</span><a name="line-193"></a><span>      </span><a name="local-6989586621679475703"><a href="#local-6989586621679475703"><span class="hs-identifier">_molType</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-194"></a><span>            </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span>
</span><a name="line-195"></a><span>        </span><span class="hs-operator hs-var">*&gt;</span><span>  </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;SMALL&quot;</span><span>
</span><a name="line-196"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;BIOPOLYMER&quot;</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;PROTEIN&quot;</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;NUCLEIC_ACID&quot;</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;SACCHARIDE&quot;</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-operator hs-var">&lt;*</span><span>  </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-201"></a><span>      </span><span class="hs-comment">-- Line 4 -&gt; &quot;charge_type&quot;</span><span>
</span><a name="line-202"></a><span>      </span><a name="local-6989586621679475704"><a href="#local-6989586621679475704"><span class="hs-identifier">_chargeType</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-203"></a><span>            </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-operator hs-var">*&gt;</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;NO_CHARGES&quot;</span><span>
</span><a name="line-205"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;DEL_RE&quot;</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;GASTEIGER&quot;</span><span>
</span><a name="line-207"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;GAST_HUCK&quot;</span><span>
</span><a name="line-208"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;HUCKEL&quot;</span><span>
</span><a name="line-209"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;PULLMAN&quot;</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;GAUSS80_CHARGES&quot;</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;AMPAC_CHARGES&quot;</span><span>
</span><a name="line-212"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;MULLIKEN_CHARGES&quot;</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;DICT_CHARGES&quot;</span><span>
</span><a name="line-214"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;MMFF94_CHARGES&quot;</span><span>
</span><a name="line-215"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;USER_CHARGES&quot;</span><span>
</span><a name="line-216"></a><span>        </span><span class="hs-special">)</span><span class="hs-operator hs-var">&lt;*</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span>
</span><a name="line-217"></a><span>        </span><span class="hs-operator hs-var">&lt;*</span><span>  </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-218"></a><span>      </span><span class="hs-comment">-- Line 5 -&gt; &quot;[status_bits&quot;</span><span>
</span><a name="line-219"></a><span>      </span><a name="local-6989586621679475705"><a href="#local-6989586621679475705"><span class="hs-identifier">_statusBit</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-220"></a><span>      </span><span class="hs-comment">-- Line 6 -&gt; &quot;[mol_comment]]&quot;</span><span>
</span><a name="line-221"></a><span>      </span><a name="local-6989586621679475706"><a href="#local-6989586621679475706"><span class="hs-identifier">_comment</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isEndOfLine</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-222"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><span class="hs-keyword">label</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475698"><span class="hs-identifier hs-var">nAtoms</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475699"><span class="hs-identifier hs-var">nBonds</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-224"></a><span>    </span><span class="hs-comment">-- Parse the @&lt;TRIPOS&gt;ATOM block of MOL2. This will give:</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-comment">-- (index of the atom, (substructure ID, substructure name), atom).</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-identifier">atomParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TL.Text</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>    </span><a name="local-6989586621679475694"><a href="#local-6989586621679475694"><span class="hs-identifier">atomParser</span></a></a><span> </span><a name="local-6989586621679475707"><a href="#local-6989586621679475707"><span class="hs-identifier">nAtoms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-228"></a><span>      </span><a name="local-6989586621679475708"><a href="#local-6989586621679475708"><span class="hs-identifier">_header</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;@&lt;TRIPOS&gt;ATOM&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-229"></a><span>      </span><span class="hs-comment">-- Parse multiple lines of ATOM data.</span><span>
</span><a name="line-230"></a><span>      </span><a name="local-6989586621679475722"><a href="#local-6989586621679475722"><span class="hs-identifier">atoms</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="#local-6989586621679475707"><span class="hs-identifier hs-var">nAtoms</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- atomLineParser</span><span>
</span><a name="line-231"></a><span>        </span><a name="local-6989586621679475709"><a href="#local-6989586621679475709"><span class="hs-identifier">index</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">decimal</span><span>
</span><a name="line-232"></a><span>        </span><span class="hs-comment">-- Most often this will be the element symbol.</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-keyword">label</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isHorizontalSpace</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-comment">-- x, y and z coordinates</span><span>
</span><a name="line-235"></a><span>        </span><a name="local-6989586621679475711"><a href="#local-6989586621679475711"><span class="hs-identifier">x</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-236"></a><span>        </span><a name="local-6989586621679475712"><a href="#local-6989586621679475712"><span class="hs-identifier">y</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-237"></a><span>        </span><a name="local-6989586621679475713"><a href="#local-6989586621679475713"><span class="hs-identifier">z</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span>
</span><a name="line-238"></a><span>        </span><span class="hs-comment">-- Parse the chemical element, which is actually the first part of the SYBYL atom type.</span><span>
</span><a name="line-239"></a><span>        </span><a name="local-6989586621679475714"><a href="#local-6989586621679475714"><span class="hs-identifier">cElem</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">letter</span><span>
</span><a name="line-240"></a><span>        </span><span class="hs-comment">-- A dot often separates the element from the type of this element.</span><span>
</span><a name="line-241"></a><span>        </span><a name="local-6989586621679475715"><a href="#local-6989586621679475715"><span class="hs-identifier">ffdot</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'.'</span><span>
</span><a name="line-242"></a><span>        </span><span class="hs-comment">-- And after the dot the rest of the SYBYL atom type might come.</span><span>
</span><a name="line-243"></a><span>        </span><a name="local-6989586621679475716"><a href="#local-6989586621679475716"><span class="hs-identifier">ffType</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isHorizontalSpace</span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">-- The substructure ID. This is the identifier to identify sub molecules.</span><span>
</span><a name="line-245"></a><span>        </span><a name="local-6989586621679475717"><a href="#local-6989586621679475717"><span class="hs-identifier">subID</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-comment">-- The substructure Name. This should be used as label for the sub molecule.</span><span>
</span><a name="line-247"></a><span>        </span><a name="local-6989586621679475718"><a href="#local-6989586621679475718"><span class="hs-identifier">subName</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isHorizontalSpace</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-comment">-- The partial charge</span><span>
</span><a name="line-249"></a><span>        </span><a name="local-6989586621679475719"><a href="#local-6989586621679475719"><span class="hs-identifier">pCharge</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">double</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-251"></a><span>          </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679475709"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-252"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679475717"><span class="hs-identifier hs-var">subID</span></a><span class="hs-special">,</span><span> </span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><a href="#local-6989586621679475718"><span class="hs-identifier hs-var">subName</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-var">Atom</span></a><span>
</span><a name="line-254"></a><span>              </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_atom_Element</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Spicy.Types.html#H"><span class="hs-identifier hs-var">H</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679475714"><span class="hs-identifier hs-var">cElem</span></a><span>
</span><a name="line-255"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Label</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-256"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_IsPseudo</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-257"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_FFType</span><span>      </span><span class="hs-glyph">=</span><span>
</span><a name="line-258"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TL.pack</span><span> </span><a href="#local-6989586621679475714"><span class="hs-identifier hs-var">cElem</span></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TL.append</span><span class="hs-special">`</span><span>
</span><a name="line-260"></a><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679475720"><a href="#local-6989586621679475720"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679475720"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-261"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679475721"><a href="#local-6989586621679475721"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679475721"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-262"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-263"></a><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679475715"><span class="hs-identifier hs-var">ffdot</span></a><span>
</span><a name="line-264"></a><span>                  </span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TL.append</span><span class="hs-special">`</span><span>
</span><a name="line-266"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679475716"><span class="hs-identifier hs-var">ffType</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_PCharge</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679475719"><span class="hs-identifier hs-var">pCharge</span></a><span>
</span><a name="line-268"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_atom_Coordinates</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679475711"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475712"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475713"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">]</span><span>
</span><a name="line-269"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-270"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><a href="#local-6989586621679475722"><span class="hs-identifier hs-var">atoms</span></a><span>
</span><a name="line-272"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-273"></a><span>    </span><span class="hs-comment">-- Parse the @&lt;TRIPOS&gt;BOND part. Unfortunately, the bonds in the MOL2 format are unidirectiorial</span><span>
</span><a name="line-274"></a><span>    </span><span class="hs-comment">-- and need to be flipped to.</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-identifier">bondParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>    </span><a name="local-6989586621679475695"><a href="#local-6989586621679475695"><span class="hs-identifier">bondParser</span></a></a><span> </span><a name="local-6989586621679475723"><a href="#local-6989586621679475723"><span class="hs-identifier">nBonds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-277"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- How often to parse bond fields depends on if the number of bonds has been specified.</span><span>
</span><a name="line-278"></a><span>          </span><a name="local-6989586621679475724"><a href="#local-6989586621679475724"><span class="hs-identifier">nParser</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-279"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679475723"><span class="hs-identifier hs-var">nBonds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-280"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">many'</span><span>
</span><a name="line-281"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679475725"><a href="#local-6989586621679475725"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="#local-6989586621679475725"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-282"></a><span>      </span><a name="local-6989586621679475726"><a href="#local-6989586621679475726"><span class="hs-identifier">_header</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;@&lt;TRIPOS&gt;BOND&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-283"></a><span>      </span><a name="local-6989586621679476038"><a href="#local-6989586621679476038"><span class="hs-identifier">uniBonds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679475724"><span class="hs-identifier hs-var">nParser</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-284"></a><span>        </span><span class="hs-comment">-- Bond id, which does not matter.</span><span>
</span><a name="line-285"></a><span>        </span><a name="local-6989586621679475727"><a href="#local-6989586621679475727"><span class="hs-identifier">_id</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>        </span><span class="hs-comment">-- Origin atom index</span><span>
</span><a name="line-287"></a><span>        </span><a name="local-6989586621679475728"><a href="#local-6989586621679475728"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>        </span><span class="hs-comment">-- Target atom index</span><span>
</span><a name="line-289"></a><span>        </span><a name="local-6989586621679475729"><a href="#local-6989586621679475729"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-comment">-- Bond type, which we don't care about.</span><span>
</span><a name="line-291"></a><span>        </span><a name="local-6989586621679476037"><a href="#local-6989586621679476037"><span class="hs-identifier">_type</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isSpace</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">skipSpace</span><span>
</span><a name="line-292"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679475728"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679475729"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Make the bonds bidirectorial</span><span>
</span><a name="line-294"></a><span>          </span><a name="local-6989586621679476039"><a href="#local-6989586621679476039"><span class="hs-identifier">bondTupleSeq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><a href="#local-6989586621679476038"><span class="hs-identifier hs-var">uniBonds</span></a><span>
</span><a name="line-295"></a><span>          </span><a name="local-6989586621679476040"><a href="#local-6989586621679476040"><span class="hs-identifier">bondsForth</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Molecule.Util.html#groupTupleSeq"><span class="hs-identifier hs-var">groupTupleSeq</span></a><span> </span><a href="#local-6989586621679476039"><span class="hs-identifier hs-var">bondTupleSeq</span></a><span>
</span><a name="line-296"></a><span>          </span><a name="local-6989586621679476041"><a href="#local-6989586621679476041"><span class="hs-identifier">bondsBack</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Molecule.Util.html#groupTupleSeq"><span class="hs-identifier hs-var">groupTupleSeq</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">swap</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679476039"><span class="hs-identifier hs-var">bondTupleSeq</span></a><span>
</span><a name="line-297"></a><span>          </span><a name="local-6989586621679476042"><a href="#local-6989586621679476042"><span class="hs-identifier">bonds</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679476040"><span class="hs-identifier hs-var">bondsForth</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679476041"><span class="hs-identifier hs-var">bondsBack</span></a><span>
</span><a name="line-298"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679476042"><span class="hs-identifier hs-var">bonds</span></a><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-comment">{-|
Parse a PDB file as described in
&lt;ftp://ftp.wwpdb.org/pub/pdb/doc/format_descriptions/Format_v33_A4.pdf&gt;. If parsing of a single ATOM
or CONETC line fails, the parser will stop there and ignore all the other records of same type,
directly coming after the failed one.

/This is not an entirely valid PDB parser. You will run into problems for very large structures,
/where atom indices exist multiple times./
-}</span><span>
</span><a name="line-309"></a><span class="hs-identifier">parsePDB</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-type">Molecule</span></a><span>
</span><a name="line-310"></a><a name="parsePDB"><a href="Spicy.Parser.html#parsePDB"><span class="hs-identifier">parsePDB</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-311"></a><span>  </span><span class="hs-comment">-- Parse the COMPND field as a label. Only the first line of COMPND will be used.</span><span>
</span><a name="line-312"></a><span>  </span><span class="hs-keyword">label</span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#maybeOption"><span class="hs-identifier hs-var">maybeOption</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;COMPND&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>    </span><a name="local-6989586621679476132"><a href="#local-6989586621679476132"><span class="hs-identifier">compoundLabel</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#skipSpace%27"><span class="hs-identifier hs-var">skipSpace'</span></a><span> </span><span class="hs-operator hs-var">*&gt;</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-315"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><a href="#local-6989586621679476132"><span class="hs-identifier hs-var">compoundLabel</span></a><span>
</span><a name="line-316"></a><span>  </span><span class="hs-comment">-- Parse atoms only and ignore other fiels</span><span>
</span><a name="line-317"></a><span>  </span><a name="local-6989586621679476134"><a href="#local-6989586621679476134"><span class="hs-identifier">atomsLabeled</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><a href="#local-6989586621679476052"><span class="hs-identifier hs-var">atomParser</span></a><span>
</span><a name="line-318"></a><span>  </span><a name="local-6989586621679476135"><a href="#local-6989586621679476135"><span class="hs-identifier">bonds</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">many'</span><span> </span><a href="#local-6989586621679476053"><span class="hs-identifier hs-var">connectParser</span></a><span>
</span><a name="line-319"></a><span>  </span><span class="hs-comment">-- links &lt;- undefined --many' linkParser</span><span>
</span><a name="line-320"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Transform the informations from the parsers.</span><span>
</span><a name="line-321"></a><span>      </span><a name="local-6989586621679476136"><a href="#local-6989586621679476136"><span class="hs-identifier">atomsIM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span>  </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679476138"><a href="#local-6989586621679476138"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679476139"><a href="#local-6989586621679476139"><span class="hs-identifier">atom</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476138"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476139"><span class="hs-identifier hs-var">atom</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476134"><span class="hs-identifier hs-var">atomsLabeled</span></a><span>
</span><a name="line-322"></a><span>      </span><a name="local-6989586621679476137"><a href="#local-6989586621679476137"><span class="hs-identifier">subMols</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Spicy.Molecule.Util.html#makeSubMolsFromAnnoAtoms"><span class="hs-identifier hs-var">makeSubMolsFromAnnoAtoms</span></a><span> </span><a href="#local-6989586621679476134"><span class="hs-identifier hs-var">atomsLabeled</span></a><span> </span><a href="#local-6989586621679476135"><span class="hs-identifier hs-var">bonds</span></a><span>
</span><a name="line-323"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Spicy.Types.html#Molecule"><span class="hs-identifier hs-var">Molecule</span></a><span>
</span><a name="line-324"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_molecule_Label</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-keyword">label</span><span>
</span><a name="line-325"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Atoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679476136"><span class="hs-identifier hs-var">atomsIM</span></a><span>
</span><a name="line-326"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Bonds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679476135"><span class="hs-identifier hs-var">bonds</span></a><span>
</span><a name="line-327"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_SubMol</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679476137"><span class="hs-identifier hs-var">subMols</span></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Energy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Gradient</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-330"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_molecule_Hessian</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-333"></a><span>    </span><span class="hs-comment">-- This parser works a little bit different than the others, as this is a fixed columnd witdth</span><span>
</span><a name="line-334"></a><span>    </span><span class="hs-comment">-- format and we can't rely on white spaces or fields really containing a value. A tuple of</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-comment">-- following structure is returned: (Index of atom, (subMolID, subMolName), atom)</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-identifier">atomParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TL.Text</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-type">Atom</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>    </span><a name="local-6989586621679476052"><a href="#local-6989586621679476052"><span class="hs-identifier">atomParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-338"></a><span>      </span><span class="hs-comment">-- First check, that this line really starts with an ATOM or HETATM record (6 characters).</span><span>
</span><a name="line-339"></a><span>      </span><span class="hs-comment">-- Columns 1-6: record type.</span><span>
</span><a name="line-340"></a><span>      </span><a name="local-6989586621679476054"><a href="#local-6989586621679476054"><span class="hs-identifier">_recordStart</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;\nATOM  &quot;</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;\nHETATM&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span>      </span><span class="hs-comment">-- Then take the rest of the line, till the end of line is reached.</span><span>
</span><a name="line-342"></a><span>      </span><a name="local-6989586621679476055"><a href="#local-6989586621679476055"><span class="hs-identifier">recordRest</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isEndOfLine</span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Recombine the line and split it according to the PDB format specifier.</span><span>
</span><a name="line-344"></a><span>          </span><a name="local-6989586621679476056"><a href="#local-6989586621679476056"><span class="hs-identifier">atomLine</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;ATOM  &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TL.append</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679476055"><span class="hs-identifier hs-var">recordRest</span></a><span>
</span><a name="line-345"></a><span>          </span><span class="hs-comment">-- Now according to the PDB specification. Fields exaclty named as in the PDF with &quot;c&quot; as</span><span>
</span><a name="line-346"></a><span>          </span><span class="hs-comment">-- prefix for chunk.</span><span>
</span><a name="line-347"></a><span>          </span><span class="hs-comment">-- Columns 1-6: record type.</span><span>
</span><a name="line-348"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476057"><a href="#local-6989586621679476057"><span class="hs-identifier">_cAtom</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476058"><a href="#local-6989586621679476058"><span class="hs-identifier">rest1</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">6</span><span> </span><a href="#local-6989586621679476056"><span class="hs-identifier hs-var">atomLine</span></a><span>
</span><a name="line-349"></a><span>          </span><span class="hs-comment">-- Column 7-11: atom serial number</span><span>
</span><a name="line-350"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476059"><a href="#local-6989586621679476059"><span class="hs-identifier">cSerial</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476060"><a href="#local-6989586621679476060"><span class="hs-identifier">rest2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">5</span><span> </span><a href="#local-6989586621679476058"><span class="hs-identifier hs-var">rest1</span></a><span>
</span><a name="line-351"></a><span>          </span><span class="hs-comment">-- Column 13-16: atom name</span><span>
</span><a name="line-352"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476061"><a href="#local-6989586621679476061"><span class="hs-identifier">cName</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476062"><a href="#local-6989586621679476062"><span class="hs-identifier">rest3</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.drop</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476060"><span class="hs-identifier hs-var">rest2</span></a><span>
</span><a name="line-353"></a><span>          </span><span class="hs-comment">-- Column 17: alternate location indicator</span><span>
</span><a name="line-354"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476063"><a href="#local-6989586621679476063"><span class="hs-identifier">_cAltLoc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476064"><a href="#local-6989586621679476064"><span class="hs-identifier">rest4</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679476062"><span class="hs-identifier hs-var">rest3</span></a><span>
</span><a name="line-355"></a><span>          </span><span class="hs-comment">-- Columnt 18-20: residue name (use this as submolecule label)</span><span>
</span><a name="line-356"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476065"><a href="#local-6989586621679476065"><span class="hs-identifier">cResName</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476066"><a href="#local-6989586621679476066"><span class="hs-identifier">rest5</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621679476064"><span class="hs-identifier hs-var">rest4</span></a><span>
</span><a name="line-357"></a><span>          </span><span class="hs-comment">-- Column 22: chain identifier</span><span>
</span><a name="line-358"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476067"><a href="#local-6989586621679476067"><span class="hs-identifier">cChainID</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476068"><a href="#local-6989586621679476068"><span class="hs-identifier">rest6</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.drop</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476066"><span class="hs-identifier hs-var">rest5</span></a><span>
</span><a name="line-359"></a><span>          </span><span class="hs-comment">-- Column 23-26: residue sequence number</span><span>
</span><a name="line-360"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476069"><a href="#local-6989586621679476069"><span class="hs-identifier">cResSeq</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476070"><a href="#local-6989586621679476070"><span class="hs-identifier">rest7</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">4</span><span> </span><a href="#local-6989586621679476068"><span class="hs-identifier hs-var">rest6</span></a><span>
</span><a name="line-361"></a><span>          </span><span class="hs-comment">-- Column 27: Code for insertion of residue</span><span>
</span><a name="line-362"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476071"><a href="#local-6989586621679476071"><span class="hs-identifier">_cICode</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476072"><a href="#local-6989586621679476072"><span class="hs-identifier">rest8</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679476070"><span class="hs-identifier hs-var">rest7</span></a><span>
</span><a name="line-363"></a><span>          </span><span class="hs-comment">-- Column 31-38: Orthogonal coordinates for x in Angstrom</span><span>
</span><a name="line-364"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476073"><a href="#local-6989586621679476073"><span class="hs-identifier">cX</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476074"><a href="#local-6989586621679476074"><span class="hs-identifier">rest9</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">8</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.drop</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476072"><span class="hs-identifier hs-var">rest8</span></a><span>
</span><a name="line-365"></a><span>          </span><span class="hs-comment">-- Column 39-46: Orthogonal coordinates for y in Angstrom</span><span>
</span><a name="line-366"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476075"><a href="#local-6989586621679476075"><span class="hs-identifier">cY</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476076"><a href="#local-6989586621679476076"><span class="hs-identifier">rest10</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">8</span><span> </span><a href="#local-6989586621679476074"><span class="hs-identifier hs-var">rest9</span></a><span>
</span><a name="line-367"></a><span>          </span><span class="hs-comment">-- Column 47-54: Orthogonal coordinates for z in Angstrom</span><span>
</span><a name="line-368"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476077"><a href="#local-6989586621679476077"><span class="hs-identifier">cZ</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476078"><a href="#local-6989586621679476078"><span class="hs-identifier">rest11</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">8</span><span> </span><a href="#local-6989586621679476076"><span class="hs-identifier hs-var">rest10</span></a><span>
</span><a name="line-369"></a><span>          </span><span class="hs-comment">-- Column 55-60: Occupancy</span><span>
</span><a name="line-370"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476079"><a href="#local-6989586621679476079"><span class="hs-identifier">_cOccupancy</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476080"><a href="#local-6989586621679476080"><span class="hs-identifier">rest12</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">6</span><span> </span><a href="#local-6989586621679476078"><span class="hs-identifier hs-var">rest11</span></a><span>
</span><a name="line-371"></a><span>          </span><span class="hs-comment">-- Column 61-66: temperature factor</span><span>
</span><a name="line-372"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476081"><a href="#local-6989586621679476081"><span class="hs-identifier">_cTempFactor</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476082"><a href="#local-6989586621679476082"><span class="hs-identifier">rest13</span></a></a><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">6</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.drop</span><span> </span><span class="hs-number">10</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476080"><span class="hs-identifier hs-var">rest12</span></a><span>
</span><a name="line-373"></a><span>          </span><span class="hs-comment">-- Column 77-78: element</span><span>
</span><a name="line-374"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476083"><a href="#local-6989586621679476083"><span class="hs-identifier">cElement</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476084"><a href="#local-6989586621679476084"><span class="hs-identifier">rest14</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621679476082"><span class="hs-identifier hs-var">rest13</span></a><span>
</span><a name="line-375"></a><span>          </span><span class="hs-comment">-- Columnt 79-80: charge on the atom</span><span>
</span><a name="line-376"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476085"><a href="#local-6989586621679476085"><span class="hs-identifier">cCharge</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476086"><a href="#local-6989586621679476086"><span class="hs-identifier">_rest15</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621679476084"><span class="hs-identifier hs-var">rest14</span></a><span>
</span><a name="line-377"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-378"></a><span>          </span><span class="hs-comment">-- Now parse all fields of interest using text readers.</span><span>
</span><a name="line-379"></a><span>          </span><a name="local-6989586621679476087"><a href="#local-6989586621679476087"><span class="hs-identifier">aSerial</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TL.decimal</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476059"><span class="hs-identifier hs-var">cSerial</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>          </span><a name="local-6989586621679476088"><a href="#local-6989586621679476088"><span class="hs-identifier">aResSeq</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TL.decimal</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476069"><span class="hs-identifier hs-var">cResSeq</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>          </span><a name="local-6989586621679476089"><a href="#local-6989586621679476089"><span class="hs-identifier">aChainID</span></a></a><span>     </span><span class="hs-glyph">=</span><span>
</span><a name="line-382"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679476097"><a href="#local-6989586621679476097"><span class="hs-identifier">cID</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679476098"><a href="#local-6989586621679476098"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679476098"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">65</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.unpack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.toUpper</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476067"><span class="hs-identifier hs-var">cChainID</span></a><span>
</span><a name="line-383"></a><span>            </span><span class="hs-keyword">in</span><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679476097"><span class="hs-identifier hs-var">cID</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-384"></a><span>                  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-385"></a><span>                  </span><span class="hs-special">(</span><a name="local-6989586621679476099"><a href="#local-6989586621679476099"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679476099"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-386"></a><span>          </span><span class="hs-comment">-- Modify the residue sequence ID with the chainID, to avoid combining fragments with same</span><span>
</span><a name="line-387"></a><span>          </span><span class="hs-comment">-- ID but different chains. Add 10000 per letter (A=0, B=10000, C=20000, ...) to avoid</span><span>
</span><a name="line-388"></a><span>          </span><span class="hs-comment">-- wrong fragmentation. The ResSeq is not unique and can occur multiple times in different</span><span>
</span><a name="line-389"></a><span>          </span><span class="hs-comment">-- chains.</span><span>
</span><a name="line-390"></a><span>          </span><a name="local-6989586621679476090"><a href="#local-6989586621679476090"><span class="hs-identifier">aChainResSeq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679476100"><a href="#local-6989586621679476100"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679476100"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679476089"><span class="hs-identifier hs-var">aChainID</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">10000</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679476088"><span class="hs-identifier hs-var">aResSeq</span></a><span>
</span><a name="line-391"></a><span>          </span><a name="local-6989586621679476091"><a href="#local-6989586621679476091"><span class="hs-identifier">aElement</span></a></a><span>     </span><span class="hs-glyph">=</span><span>
</span><a name="line-392"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679476101"><a href="#local-6989586621679476101"><span class="hs-identifier">elemMaybe</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-393"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Spicy.Types.html#Element"><span class="hs-identifier hs-type">Element</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>                  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.unpack</span><span>
</span><a name="line-395"></a><span>                  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.toTitle</span><span>
</span><a name="line-396"></a><span>                  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span>
</span><a name="line-397"></a><span>                  </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476083"><span class="hs-identifier hs-var">cElement</span></a><span>
</span><a name="line-398"></a><span>            </span><span class="hs-keyword">in</span><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679476101"><span class="hs-identifier hs-var">elemMaybe</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-399"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;parsePDB: Could not read the element symbol.&quot;</span><span>
</span><a name="line-400"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679476102"><a href="#local-6989586621679476102"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679476102"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-401"></a><span>          </span><a name="local-6989586621679476092"><a href="#local-6989586621679476092"><span class="hs-identifier">aLabel</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span> </span><a href="#local-6989586621679476061"><span class="hs-identifier hs-var">cName</span></a><span>
</span><a name="line-402"></a><span>          </span><a name="local-6989586621679476093"><a href="#local-6989586621679476093"><span class="hs-identifier">aFFType</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-403"></a><span>          </span><a name="local-6989586621679476094"><a href="#local-6989586621679476094"><span class="hs-identifier">aPCharge</span></a></a><span>     </span><span class="hs-glyph">=</span><span>
</span><a name="line-404"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679476103"><a href="#local-6989586621679476103"><span class="hs-identifier">pChargeMaybe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TL.double</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476085"><span class="hs-identifier hs-var">cCharge</span></a><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>            </span><span class="hs-keyword">in</span><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679476103"><span class="hs-identifier hs-var">pChargeMaybe</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-406"></a><span>                  </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-407"></a><span>                  </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679476104"><a href="#local-6989586621679476104"><span class="hs-identifier">pC</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679476104"><span class="hs-identifier hs-var">pC</span></a><span>
</span><a name="line-408"></a><span>          </span><a name="local-6989586621679476095"><a href="#local-6989586621679476095"><span class="hs-identifier">aCoordinates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.double</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679476073"><span class="hs-identifier hs-var">cX</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476075"><span class="hs-identifier hs-var">cY</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476077"><span class="hs-identifier hs-var">cZ</span></a><span class="hs-special">]</span><span>
</span><a name="line-409"></a><span>          </span><span class="hs-comment">-- Use the Atom constructor applicatively to get Either String Atom. This relies on the</span><span>
</span><a name="line-410"></a><span>          </span><span class="hs-comment">-- order of the atom arguments.</span><span>
</span><a name="line-411"></a><span>          </span><a name="local-6989586621679476096"><a href="#local-6989586621679476096"><span class="hs-identifier">eitherAtom</span></a></a><span>   </span><span class="hs-glyph">=</span><span>
</span><a name="line-412"></a><span>            </span><a href="Spicy.Types.html#Atom"><span class="hs-identifier hs-var">Atom</span></a><span>
</span><a name="line-413"></a><span>            </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679476091"><span class="hs-identifier hs-var">aElement</span></a><span>            </span><span class="hs-comment">-- _atom_Element</span><span>
</span><a name="line-414"></a><span>            </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679476092"><span class="hs-identifier hs-var">aLabel</span></a><span>         </span><span class="hs-comment">-- _atom_Label</span><span>
</span><a name="line-415"></a><span>            </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">False</span><span>          </span><span class="hs-comment">-- _atom_IsPseudo</span><span>
</span><a name="line-416"></a><span>            </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679476093"><span class="hs-identifier hs-var">aFFType</span></a><span>        </span><span class="hs-comment">-- _atom_FFType</span><span>
</span><a name="line-417"></a><span>            </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679476094"><span class="hs-identifier hs-var">aPCharge</span></a><span>       </span><span class="hs-comment">-- _atom_FFType</span><span>
</span><a name="line-418"></a><span>            </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679476095"><span class="hs-identifier hs-var">aCoordinates</span></a><span>        </span><span class="hs-comment">-- _atom_Coordinates</span><span>
</span><a name="line-419"></a><span>      </span><span class="hs-comment">-- If all the non-Attoparsec parse actions succeeded, return an Attoparsec result or fail with</span><span>
</span><a name="line-420"></a><span>      </span><span class="hs-comment">-- an Attoparsec error.</span><span>
</span><a name="line-421"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476087"><span class="hs-identifier hs-var">aSerial</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476090"><span class="hs-identifier hs-var">aChainResSeq</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476065"><span class="hs-identifier hs-var">cResName</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476096"><span class="hs-identifier hs-var">eitherAtom</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-422"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679476105"><a href="#local-6989586621679476105"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679476106"><a href="#local-6989586621679476106"><span class="hs-identifier">sInd</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679476107"><a href="#local-6989586621679476107"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476105"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476106"><span class="hs-identifier hs-var">sInd</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476065"><span class="hs-identifier hs-var">cResName</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476107"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679476108"><a href="#local-6989586621679476108"><span class="hs-identifier">indErr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621679476108"><span class="hs-identifier hs-var">indErr</span></a><span>
</span><a name="line-424"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679476109"><a href="#local-6989586621679476109"><span class="hs-identifier">sIndErr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621679476109"><span class="hs-identifier hs-var">sIndErr</span></a><span>
</span><a name="line-425"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679476110"><a href="#local-6989586621679476110"><span class="hs-identifier">aErr</span></a></a><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621679476110"><span class="hs-identifier hs-var">aErr</span></a><span>
</span><a name="line-426"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-427"></a><span>    </span><span class="hs-comment">-- Parse CONECT fields of the PDB. PDB bonds are bidirectorial, so no swapping required.</span><span>
</span><a name="line-428"></a><span>    </span><span class="hs-identifier">connectParser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>    </span><a name="local-6989586621679476053"><a href="#local-6989586621679476053"><span class="hs-identifier">connectParser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-430"></a><span>      </span><span class="hs-comment">-- First check, that this line really starts with a CONECT record (6 characters).</span><span>
</span><a name="line-431"></a><span>      </span><span class="hs-comment">-- Columns 1-6: record type.</span><span>
</span><a name="line-432"></a><span>      </span><a name="local-6989586621679476111"><a href="#local-6989586621679476111"><span class="hs-identifier">_recordStart</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TL.pack</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">manyTill</span><span> </span><span class="hs-identifier hs-var">anyChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">string</span><span> </span><span class="hs-string">&quot;CONECT&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>      </span><span class="hs-comment">-- Then take the rest of the line, till the end of line is reached.</span><span>
</span><a name="line-434"></a><span>      </span><a name="local-6989586621679476112"><a href="#local-6989586621679476112"><span class="hs-identifier">recordRest</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Spicy.Parser.html#textS2L"><span class="hs-identifier hs-var">textS2L</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isEndOfLine</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><span class="hs-identifier hs-var">endOfLine</span><span>
</span><a name="line-435"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Recombine the line and split them according to PDB standard.</span><span>
</span><a name="line-436"></a><span>          </span><a name="local-6989586621679476113"><a href="#local-6989586621679476113"><span class="hs-identifier">conectLine</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;CONECT&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TL.append</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679476112"><span class="hs-identifier hs-var">recordRest</span></a><span>
</span><a name="line-437"></a><span>          </span><span class="hs-comment">-- Columns 1-6: &quot;CONECT&quot;</span><span>
</span><a name="line-438"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476114"><a href="#local-6989586621679476114"><span class="hs-identifier">_cConect</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476115"><a href="#local-6989586621679476115"><span class="hs-identifier">rest1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">6</span><span> </span><a href="#local-6989586621679476113"><span class="hs-identifier hs-var">conectLine</span></a><span>
</span><a name="line-439"></a><span>          </span><span class="hs-comment">-- Columns 7-11: serial of origin atom.</span><span>
</span><a name="line-440"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476116"><a href="#local-6989586621679476116"><span class="hs-identifier">cOrigin</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476117"><a href="#local-6989586621679476117"><span class="hs-identifier">rest2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">5</span><span> </span><a href="#local-6989586621679476115"><span class="hs-identifier hs-var">rest1</span></a><span>
</span><a name="line-441"></a><span>          </span><span class="hs-comment">-- Columns 12-16, 17-21, 22-26,27-31: serial of a target atoms.</span><span>
</span><a name="line-442"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476118"><a href="#local-6989586621679476118"><span class="hs-identifier">cTarget1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476119"><a href="#local-6989586621679476119"><span class="hs-identifier">rest3</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">5</span><span> </span><a href="#local-6989586621679476117"><span class="hs-identifier hs-var">rest2</span></a><span>
</span><a name="line-443"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476120"><a href="#local-6989586621679476120"><span class="hs-identifier">cTarget2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476121"><a href="#local-6989586621679476121"><span class="hs-identifier">rest4</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">5</span><span> </span><a href="#local-6989586621679476119"><span class="hs-identifier hs-var">rest3</span></a><span>
</span><a name="line-444"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476122"><a href="#local-6989586621679476122"><span class="hs-identifier">cTarget3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476123"><a href="#local-6989586621679476123"><span class="hs-identifier">rest5</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">5</span><span> </span><a href="#local-6989586621679476121"><span class="hs-identifier hs-var">rest4</span></a><span>
</span><a name="line-445"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679476124"><a href="#local-6989586621679476124"><span class="hs-identifier">cTarget4</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679476125"><a href="#local-6989586621679476125"><span class="hs-identifier">_rest6</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TL.splitAt</span><span> </span><span class="hs-number">5</span><span> </span><a href="#local-6989586621679476123"><span class="hs-identifier hs-var">rest5</span></a><span>
</span><a name="line-446"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-447"></a><span>          </span><span class="hs-comment">-- Now parse all fields of interest using text readers.</span><span>
</span><a name="line-448"></a><span>          </span><a name="local-6989586621679476126"><a href="#local-6989586621679476126"><span class="hs-identifier">pOrigin</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TL.decimal</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679476116"><span class="hs-identifier hs-var">cOrigin</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>          </span><span class="hs-identifier">pTargets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">IntSet</span><span>
</span><a name="line-450"></a><span>          </span><a name="local-6989586621679476127"><a href="#local-6989586621679476127"><span class="hs-identifier">pTargets</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-451"></a><span>              </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">IS.fromList</span><span>
</span><a name="line-452"></a><span>            </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sequence</span><span>
</span><a name="line-453"></a><span>            </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isRight</span><span>
</span><a name="line-454"></a><span>            </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.decimal</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TL.strip</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679476118"><span class="hs-identifier hs-var">cTarget1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476120"><span class="hs-identifier hs-var">cTarget2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476122"><span class="hs-identifier hs-var">cTarget3</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476124"><span class="hs-identifier hs-var">cTarget4</span></a><span class="hs-special">]</span><span>
</span><a name="line-456"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476126"><span class="hs-identifier hs-var">pOrigin</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476127"><span class="hs-identifier hs-var">pTargets</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-457"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679476128"><a href="#local-6989586621679476128"><span class="hs-identifier">o</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679476129"><a href="#local-6989586621679476129"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679476128"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679476129"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679476130"><a href="#local-6989586621679476130"><span class="hs-identifier">oErr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621679476130"><span class="hs-identifier hs-var">oErr</span></a><span>
</span><a name="line-459"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679476131"><a href="#local-6989586621679476131"><span class="hs-identifier">tErr</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621679476131"><span class="hs-identifier hs-var">tErr</span></a><span>
</span><a name="line-460"></a></pre></body></html>